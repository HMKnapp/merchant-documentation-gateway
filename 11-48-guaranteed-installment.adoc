[#GuaranteedInstallment]
=== Guaranteed Installments

[#GuaranteedInstallment_GeneralInformation]
==== General Information

[#GuaranteedInstallment_CountriesandCurrencies]
===== Payment Mode, Countries and Currencies

This table illustrates which payment mode _Guaranteed Installments_ belongs to. It also provides detailed
information about the countries and currencies which are relevant for
_Guaranteed Installments._

[%autowidth,stripes=none,cols="h,"]
|===
| Payment Mode | <<PaymentMethods_PaymentMode_OfflineBankTransfer, Offline Bank Transfer>>
| Countries    | DE, AT, CH +
                 on Payment Page environment: DE only
| Currencies   | EUR, CHF
|===

[#GuaranteedInstallment_Communication]
===== Communication Formats

This table illustrates how _Guaranteed Installments_ notifications are encoded and which formats and methods can be
used for requests and responses.

[%autowidth,stripes=none]
|===
.2+h| Requests/Responses | Format  | XML
                         | Methods | POST
   h| IPN Encodement   2+| Please follow the instructions given at <<GeneralPlatformFeatures_IPN, Instant Payment Notification>> to set up IPN.
|===

[#GuaranteedInstallment_TransactionTypes]
==== Transaction Types

For <<Glossary_TransactionType, transaction type>> details which are not given here, look
at <<AppendixB, AppendixB: Transaction Types>>.


[%autowidth,stripes=none, cols="e,,"]
|===
|Transaction Type | Description | Link to samples

|_authorization_    | Performs a creditworthiness check at the moment when
                    consumer makes an order. All order items must be listed for the shopping
                    basket. The _authorization_ amount must match the value of the items in
                    the basket.
                                | <<GuaranteedInstallment_Samples_GuaranteedInstallment, _Guaranteed Installments_ samples>>

|_capture-authorization_ | Used to capture the reserved funds at the moment
                         when some or all goods are physically delivered to the consumer.
                         Available only on successful _authorization_ response which wasn't voided
                         nor fully captured. Partial (and multiple) capture is allowed, until
                         the _authorization_ limit is not exceeded. Basket items only lists the
                         items that were delivered to the consumer in this delivery, not the ones
                         that were delivered before or are waiting to be delivered. The total
                         amount of the capture must be the value of the items in the basket.
                                | <<GuaranteedInstallment_Samples_GuaranteedInstallment, _Guaranteed Installments_ samples>>

|_void-authorization_ | Used when the consumer wishes to cancel some or all
                      (not yet shipped) items from the order. Available only for a successful
                      _authorization_ response which was not yet voided or captured. Partial and
                      multiple void are allowed, until all items from the order are canceled
                      or shipped. Basket items only list those items which are being canceled from the order.
                                | <<GuaranteedInstallment_Samples_GuaranteedInstallment, _Guaranteed Installments_ samples>>

|_refund-capture_ | Used when the consumer wishes to return some or all
                  delivered goods. Available on a successful _capture-authorization_.
                  Partial and multiple refunds are allowed, until all delivered items have
                  been returned. Basket items list only those items which are being returned to the merchant.
                                | <<GuaranteedInstallment_Samples_GuaranteedInstallment, _Guaranteed Installments_ samples>>

|_credit_ | Used when merchant wishes to grant a discount on an existing
          order. Items from this order may already be delivered to the consumer.
          Available on a successful _capture-authorization_. Multiple credits are
          allowed, but the overall sum of credits must not exceed the value of the
          delivered goods to the consumer. The credit transaction must include a
          basket item representing the discount. The credit transaction must refer
          to the successful _authorization_ ``transaction-id``.
                                | <<GuaranteedInstallment_Samples_GuaranteedInstallment, _Guaranteed Installments_ samples>>
|===

[NOTE]
====
. <<GuaranteedInstallment_BasketItemsDetails, Basket items>>  must be specified in every request.
. The response for each _authorization_ request returns an individual
string (an alphanumerical code) in the
field ``descriptor``.
. The descriptor must be printed on all invoice documents and saved by
the shop (used by consumers in bank transfers; German:
"Verwendungszweck").­­
. _capture-authorization_ transactions have to follow a successful
_authorization_ on the same day the goods are dispatched.
. The period between _authorization_ and the first
_capture-authorization_ must be at least 4 hours.
. Merchants can request several partial _capture-authorization_ transactions if the goods
are shipped in separate shipments.

//-
====

[#GuaranteedInstallment_TestCredentials]
==== Test Credentials

[%autowidth,stripes=none]
|===
h| URLs (Endpoint)           | `\https://{test-instance-hostname}/engine/rest/paymentmethods`
h| Merchant Account ID (MAID) | 9df7b8a6-546a-4e01-9fe5-ccc3ae54b23e
h| Username                   | 16390-testing
h| Password                   | 3!3013=D3fD8X7
|===

//-

[#GuaranteedInstallment_TestCredentials_Additional]
.Banking Credentials

[cols="20h,80"]
|===
| IBAN
| DE42512308000000060004

| BIC
|WIREDEMMXXX
|===

//-

[#GuaranteedInstallment_Workflow]
==== Workflow

[mermaid, GuaranteedInstallment_workflow,svg,subs=attributes+]
----
sequenceDiagram
    participant Consumer
    participant Merchant
    participant {payment-gateway-abbr}
    participant {payment-provider-name} Bank
Consumer->>Consumer: adds items to shopping basket
Consumer->>Consumer: selects Guaranteed Installment
Consumer->>Merchant: proceeds to checkout
Merchant->>{payment-gateway-abbr}: sends authorization request
{payment-gateway-abbr}->>{payment-gateway-abbr}: generates descriptor
{payment-gateway-abbr}->>Merchant: sends authorization response
Merchant->>{payment-gateway-abbr}: sends a capture request
{payment-gateway-abbr}->>{payment-gateway-abbr}: generates invoice
{payment-gateway-abbr}->>{payment-provider-name} Bank: informs
{payment-provider-name} Bank->>{payment-provider-name} Bank: collects the transaction amount
----

. Consumer adds items to shopping basket.
. Consumer selects the payment method _Guaranteed Installments._
.. Selects duration and rate of payment.
. Consumer proceeds to checkout.
. Merchant sends an _authorization_ request including basket items to {payment-gateway-abbr}.
. {payment-gateway-abbr} generates a descriptor.
..  Descriptor is an alphanumerical code, starting with DG.
. {payment-gateway-abbr} sends _authorization_ response to merchant. 
.. The _authorization_ response includes the descriptor.
. Merchant sends a _capture_ request to {payment-gateway-abbr} when the basket items are ready for delivery.
. After a successful _capture_ request, {payment-gateway-abbr} generates the invoice, including the descriptor.
.. NOTE: Alternatively the invoice can also be generated by merchant.
. Invoice generator informs {payment-provider-name} Bank.
. {payment-provider-name} Bank collects the transaction amount from consumer's bank account.
. If any payment changes are necessary, the following transaction types are available: _credit_, _refund-capture_ or _void-authorization_.

//-

[#GuaranteedInstallment_Fields]
==== Fields

The following elements are mandatory *M*, optional *O* or conditional
*C* for sending a request for the payment method _Guaranteed Installments_ (complete field
list available in <<RestApi_Fields, REST API field list>>):

[%autowidth,stripes=none, cols="v,,,,"]
|===
| Field  | Cardinality  | Datatype  | Size  | Description

5+a|
[[GuaranteedInstallment_Fields_Payment]]
[discrete]
===== payment

|_merchant-account-id_
|M
|String
|36
|Unique identifier for a merchant account

|_request-id_
|M
|String
|150
|This is the identification number of the request.
*It has to be unique for each request.*

|_transaction-type_
|M
|String
|30
|This is the type for a transaction: _authorization_, _capture_, _void-authorization_, _refund-capture_ and _credit_ are supported for _Guaranteed Installments_.

|_requested-amount_
|M
|Numeric
|18,3
|This is the amount of the transaction. The amount of the decimal place depends on the currency. The amount must be between a defined minimum value and a defined maximum value.

|_requested-amount@currency_
|M
|String
|?????
|This is the currency of the transaction. For Germany and Austria, only ``EUR`` is allowed. Switzerland additionally accepts ``CHF``.

|_order-detail_
|O
|String
|65535
|Details of the order filled by the merchant.

|_order-number_
|M
|String
|64
|The order number from the merchant.

|_consumer-id_
|O
|String
|50 ?????
|Merchant's identifier for the consumer.

|_invoice-id_
|O
|String
|?????
|Merchant's invoice identifier.

|_creditor-id_
|M/O
|String
|256 ?????
|Wirecard Bank creditor identifier, provided by Wirecard Support. QUESTION: When is it mandatory?????

|_locale_
|O
|String
|6 ?????
|It is used to control the language of the consumer message and the correspondence to the consumer. Allowed values: ``fr``, ``en``, ``nl``, ``de``.
If empty or with wrong value, German language is used by default. The same logic applies for Payment Page integration.

|_api-id_
|M/O
|Token ????? Why token? Does api-id follow a certain pattern value?
|36 ?????
|????? Spec says: "Mandatory for authorization via HPP". But here we talk about REST.

5+a|
[[GuaranteedInstallment_Fields_PaymentMethods]]
[discrete]
===== payment-methods

|_payment-methods.payment-method@name_
|M
|String
|15
|The name of the Payment Method is ``ratepay-install``.

5+a|
[[GuaranteedInstallment_Fields_AccountHolder]]
[discrete]
===== account-holder

|_account-holder.first-name_
|M
|String
|32 ?????
|Account holder's first name.

|_account-holder.last-name_
|M
|String
|32 ?????
|Account holder's last name.

|_account-holder.email_
|M
|String
|64 ?????
|Account holder's email address.

|_account-holder.phone_
|M
|String
|32 ?????
|Account holder's phone number.

|_account-holder.date-of-birth_
|M
|String
|n/a ?????
|Account holder's date of birth.

|_account-holder.gender_
|O
|Enumeration
|1 ?????
|Account holder's gender.

5+a|
[[GuaranteedInstallment_Fields_AccountHolderAddress]]
[discrete]
===== account-holder.address

|_account-holder.address.street1_
|M
|String
|128 ?????
|The first line of the street address of the account holder. Must include house number.

|_account-holder.address.street2_
|O
|String
|128 ?????
|The second line of the street address of the account holder.

|_account-holder.address.city_
|M
|String
|32 ?????
|The city of the address of the account holder.

|_account-holder.address.state_
|O
|String
|32 ?????
|The state or province of the address of the account holder.

|_account-holder.address.country_
|M
|Token ????? Why token? Which ISO Norm is used here?
|3 ?????
|The Country Id of the address of the account holder.

|_account-holder.address.postal-code_
|M
|String
|16 ?????
|The postal code or ZIP of the address of the account holder.

4+a|
[[GuaranteedInstallment_Fields_BankAccount]]
[discrete]
===== bank-account

|Consumer's bank account details.

|_bank-account.bank-name_
|M
|String
|100 ?????
|The name of the consumer’s bank.

|_bank-account.iban_
|M/O
|String
|34 ?????
|The international bank account number (IBAN) required in a bank transfer. It is an international standard for identifying bank accounts across national borders. The current standard is ISO 13616:2007, which indicates SWIFT as the formal registrar. +
Allowed characters: [a-zA-Z]{2}[0-9]{2}[a-zA-Z0-9]{4}[0-9]{7}([a-zA-Z0-9]?){0,16}. +
Mandatory if ``account-number`` is not used

|_bank-account.bic_
|M/O
|String
|15 ?????
|The bank identifier code (BIC) in bank transfer. +
Allowed characters: ([a-zA-Z]{4}[a-zA-Z]{2}[a-zA-Z0-9]{2}([a-zA-Z0-9]{3}). +
Mandatory if ``iban`` is used

|_bank-account.account-number_
|M/O
|String
|34 ?????
|The number designating a bank account used nationally. +
Mandatory if ``iban`` is not used

|_bank-account.bank-code_
|M/O
|String
|15 ?????
|The national bank sorting code for national bank transfers. +
Mandatory if ``account-number`` is used

5+a|
[[GuaranteedInstallment_Fields_OrderItems]]
[discrete]
===== order-items

|_order-items.order-item.name_
|M
|String
|?????
|Name of the item in the basket.

|_order-items.order-item.article-number_
|M
|String
|?????
|EAN or other article identifier for merchant.

|_order-items.order-item.amount_
|M
|Number
|?????
|Item's price per unit.

|_order-items.order-item.tax-rate_
|M
|Number
|?????
|Item's tax rate per unit.

|_order-items.order-item.quantity_
|M
|Number
|?????
|Total count of items in the order.

4+a|
[[GuaranteedInstallment_Fields_Shipping]]
[discrete]
===== shipping

|Shipping fields have to match the billing address (specified as <<GuaranteedInstallment_Fields_AccountHolder, account-holder>>).

|_shipping/first-name_
|O
|String
|32 ?????
|The first name of the shipping address.

|_shipping/last-name_
|O
|String
|32 ?????
|The last name of the shipping address.

|_shipping/phone_
|O
|String
|32 ?????
|The phone number of the shipping address.

4+a|
[[GuaranteedInstallment_Fields_ShippingAaddress]]
[discrete]
===== shipping/address

|Shipping/address fields have to match the billing address (specified as <<GuaranteedInstallment_Fields_AccountHolderAddress, account-holder.address>>).

|_shipping/address/street1_
|O
|String
|128 ?????
|The first line of the shipping address.

|_shipping/address/street2_
|O
|String
|128 ?????
|The second line of the shipping address.

|_shipping/address/city_
|O
|String
|32 ?????
|The city of the shipping address.

|_shipping/address/state_
|O
|String
|32 ?????
|The state or province of the shipping address.

|_shipping/address/country_
|O
|String
|3 ?????
|The Country Id of the shipping address. Is this a three character ISO value????? If yes, which one?????

|_shipping/address/postal-code_
|O
|String
|16?????
|The postal code or ZIP of the shipping address.

5+a|
[[GuaranteedInstallment_Fields_Device]]
[discrete]
===== device

|_device/fingerprint_
|M/O
|String
|4096 ?????
|Device fingerprinting token that was used in merchant's online shop to track this transaction. Fingerprints can be used to fully or partially identify individual users or devices even when cookies are turned off. +
It is mandatory for _authorization_.

5+a|
[[GuaranteedInstallment_Fields_Mandate]]
[discrete]
===== mandate

|_mandate.mandate-id_
|M/O
|String
|35 ?????
|Mandate ID will be generated by Wirecard. Please use the following statement as placeholder: "Wird nach Kaufabschluss übermittelt"

5+a|
[[GuaranteedInstallment_Fields_Custom]]
[discrete]
===== custom-fields

|_custom-field@name="total-amount"_
|M
|?????
|?????
|Mapping for authorization: custom-field@value=installment-calculator-response/installments/installment/details/total-amount

|_custom-field@name="interest-rate"_
|M
|?????
|?????
|Mapping for authorization: custom-field@value= installment-calculator-response/installments/installment/details/interest-rate

|_custom-field@name="number-of-rates"_
|M
|?????
|?????
|Mapping for authorization: custom-field@value= installment-calculator-response/installments/installment/details/number-of-rates

|_custom-field@name="rate"_
|M
|?????
|?????
|Mapping for authorization: custom-field@value= installment-calculator-response/installments/installment/details/rate

|_custom-field@name="last-rate"_
|M
|?????
|?????
|Mapping for authorization: custom-field@value=installment-calculator-response/installments/installment/details/last-rate

|_custom-field@name="payment-firstday"_
|M
|?????
|?????
|Mapping for authorization: custom-field@value= installment-calculator-response/installments/installment/details/payment-first-day
|===

//-

[#GuaranteedInstallment_Features]
==== Features

[#GuaranteedInstallment_BasketItemsDetails]
===== Basket Items Details

Basket items details must be <<GuaranteedInstallment_Fields_OrderItems, sent along with every request>>. Content of
the shopping basket depends on the location of the items.
There can be 3 different locations:

- the (distribution) storage of the merchant,
- the delivery (items are „on the road"); and
- home of the consumer.

//-

The shopping basket always contains the items that are being authorized
(ordered), captured (delivered), voided (canceled), refunded (returned)
or credited depending to the transaction type.

The detailed items of the shopping basket will be stored as a part of
payment details on provider and they can be obtained from _{payment-gateway}_ later as part of transaction details.

[#GuaranteedInstallment_Samples]
==== Samples

Click <<GeneralPlatformFeatures_IPN_NotificationExamples, here>> for corresponding notification samples.

[#GuaranteedInstallment_Samples_GuaranteedInstallment]
===== Guaranteed Installments

[#GuaranteedInstallment_Samples_GuaranteedInstallment_Authorization]
====== _authorization_

.XML authorization Request (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

.XML authorization Response (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

[#GuaranteedInstallment_Samples_GuaranteedInstallment_CaptureAuthorization]
====== _capture-authorization_

.XML capture-authorization Request (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

.XML capture-authorization Response (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

[#GuaranteedInstallment_Samples_GuaranteedInstallment_Credit]
====== _credit_

.XML credit Request (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

.XML credit Response (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

[#GuaranteedInstallment_Samples_GuaranteedInstallment_RefundCapture]
====== _refund-capture_

.XML refund-capture Request (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

.XML refund-capture Response (Successful)
[source,xml,subs=attributes+]
----
include::[]
----


[#GuaranteedInstallment_Samples_GuaranteedInstallment_VoidAuthorization]
====== _void-authorization_

.XML void-authorization Request (Successful)
[source,xml,subs=attributes+]
----
include::[]
----

.XML void-authorization Response (Successful)

[source,xml,subs=attributes+]
----
include::[]
----

//-