[#API_CC_3DS2_UC_delayed-shipment]
=== Delayed Shipment

[#API_CC_3DS2_UC_delayed-shipment_expect]
==== Option 1: Expected Delay

image::{root}/images/uc-delayed-shipment/uc-delayed-shipment-expected.png[3DS2 Use Cases Delayed Shipment]

NOTE: In a delayed shipment with an expected delay an _authorization-only_ preceeds the check-enrollment.
 
* _authorization-only_ +
If there is an expected delay of max. 90 days you can start this payment process with an authorization-only. This transaction doesn't reserve any money. It only ..... > What does it do?
 
check-enrollment (> link to the description of check-enrollment)

After the ceck-enrollment or check-payer-response the payment process is halted until the goods have become available and are ready to be shipped. The payment process is resumed with an _authorization_ and completed with a _capture-authorization_.
 
* _authorization_ +
The _authorization_ must reference either the previous check-enrollment, or the check-payer-response, depending on whether the check-payer-response has been executed or not.
 
    Following check-enrollment: Include the transaction-id from the check-enrollment response in the parent-transaction-id field.
 
    Following (optional) check-payer-response: Include the transaction-id returned by the check-payer-response in the parent-transaction-id field.
 
If the check-payer-response was not executed, use the PARes received via TermURL as part of the response to the ACS HTTP POST request.
 
* _capture-authorization_ +
The _capture-authorization_ must reference the transaction-id from the _authorization_ response in the parent-transaction-id field.

    Following _authorization_: Include the transaction-id from the _authorization_ response in the parent-transaction-id field.
 

[#API_CC_3DS2_UC_delayed-shipment_unexpect]
==== Option 2: Unexpected Delay

In a delayed shipment with an unexpected delay an _authorization_ follows the transaction types _check-enrollment_ and _check-payer-response_.
 
* _authorization_ (full amount)
  An _authorization_ is the first transaction after the _check-enrollment_, or the _check-payer-response_, depending on whether the _check-payer-response_ has been executed or not.
  In this _authorization_ the whole amount for the transaction is authorized
 
    Following _check-enrollment_: Include the transaction-id from the _check-enrollment_ response in the parent-transaction-id field.
 
    Following (optional) _check-payer-response_: Include the transaction-id returned by the _check-payer-response_ in the parent-transaction-id field.
 
If the _check-payer-response_ was not executed, instead use the PARes received via TermURL as part of the response to the ACS HTTP POST request.

.XML _authorization_ Request (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment">
    <merchant-account-id>33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <request-id>{{$guid}}</request-id>
    <transaction-type>authorization</transaction-type>
    <requested-amount currency="EUR">10.00</requested-amount>
    <parent-transaction-id>22f8d84b-d7bf-4034-9c55-03664fed0fb8</parent-transaction-id>
    <order-detail>{{$handler}}</order-detail>
    <descriptor>{{$descriptor}}</descriptor>
</payment>
----
//include::{root}/auto-generated/samples/xml/CreditCard_Non3D_Preauthorization_request.xml[]

.XML _authorization_ Response (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment" self="https://api-test.wirecard.com:443/engine/rest/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1/payments/d0d04f90-1af3-4ab9-83e1-42eb5b6d3617">
    <merchant-account-id ref="https://api-test.wirecard.com:443/engine/rest/config/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1">33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <transaction-id>d0d04f90-1af3-4ab9-83e1-42eb5b6d3617</transaction-id>
    <request-id>8e525739-7942-41b3-b416-4dd4df9b0fbd</request-id>
    <transaction-type>authorization</transaction-type>
    <transaction-state>success</transaction-state>
    <completion-time-stamp>2020-02-11T12:46:48.000Z</completion-time-stamp>
    <statuses>
        <status code="201.0000" description="3d-acquirer:The resource was successfully created." severity="information"/>
        <status code="200.1083" description="3d-acquirer:Cardholder Successfully authenticated." severity="information"/>
    </statuses>
    <requested-amount currency="EUR">10.00</requested-amount>
    <parent-transaction-id>22f8d84b-d7bf-4034-9c55-03664fed0fb8</parent-transaction-id>
    <account-holder>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <email>ppeter@example.com</email>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <merchant-crm-id>XWLfrzuGhpajYxFiFgNScwcLhtIOvXNxMIcrxIPTHqgroaFiPNDqMxGBXYUhMVBZ</merchant-crm-id>
    </account-holder>
    <shipping>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <shipping-method>home_delivery</shipping-method>
    </shipping>
    <card>
        <expiration-month>1</expiration-month>
        <expiration-year>2023</expiration-year>
        <card-type>mastercard</card-type>
    </card>
    <card-token>
        <token-id>5489620654931192</token-id>
        <masked-account-number>541333******1192</masked-account-number>
    </card-token>
    <ip-address>127.0.0.1</ip-address>
    <order-detail>66a3281e-ef43-537c-d9e9-aee73c41a9fc</order-detail>
    <descriptor>3DS-2 Use-Cases: Delayed Shipment - Un-Expected Dalay</descriptor>
    <notifications format="application/json">
        <notification url="http://www.webhook.site/68f1326e-311d-4ef8-a998-1c3c66cc497a"/>
    </notifications>
    <payment-methods>
        <payment-method name="creditcard"/>
    </payment-methods>
    <parent-transaction-amount currency="EUR">0.000000</parent-transaction-amount>
    <authorization-code>252435</authorization-code>
    <three-d>
        <cardholder-authentication-status>Y</cardholder-authentication-status>
        <version_requested>2.1.0</version_requested>
    </three-d>
    <api-id>elastic-api</api-id>
    <provider-account-id>70003</provider-account-id>
</payment>
----
 
* _void-authorization_
If the delay has become apparent the authorzied amount will be voided. The _void-authorization_ includes the transaction-id from the _authorization_ in the parent-transaction-id field.

.XML _void-authorization_ Request (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment">
    <merchant-account-id>33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <request-id>{{$guid}}</request-id>
    <transaction-type>void-authorization</transaction-type>
    <requested-amount currency="EUR">10.00</requested-amount>
    <notifications format="application/json">
        <notification url="http://www.webhook.site/68f1326e-311d-4ef8-a998-1c3c66cc497a"></notification>
    </notifications>
    <parent-transaction-id>d0d04f90-1af3-4ab9-83e1-42eb5b6d3617</parent-transaction-id>
    <order-detail>{{$handler}}</order-detail>
    <descriptor>{{$descriptor}}</descriptor>
</payment>
----
//include::{root}/auto-generated/samples/xml/CreditCard_Non3D_Preauthorization_request.xml[]

.XML _void-authorization_ Response (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment" self="https://api-test.wirecard.com:443/engine/rest/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1/payments/8cd08798-4bf5-4173-81a9-2c90fef8aaa6">
    <merchant-account-id ref="https://api-test.wirecard.com:443/engine/rest/config/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1">33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <transaction-id>8cd08798-4bf5-4173-81a9-2c90fef8aaa6</transaction-id>
    <request-id>a635fc7e-a6ac-4bb8-8826-d8e440793e89</request-id>
    <transaction-type>void-authorization</transaction-type>
    <transaction-state>success</transaction-state>
    <completion-time-stamp>2020-02-11T12:48:54.000Z</completion-time-stamp>
    <statuses>
        <status code="201.0000" description="3d-acquirer:The resource was successfully created." severity="information"/>
        <status code="200.1083" description="3d-acquirer:Cardholder Successfully authenticated." severity="information"/>
    </statuses>
    <requested-amount currency="EUR">10.00</requested-amount>
    <parent-transaction-id>d0d04f90-1af3-4ab9-83e1-42eb5b6d3617</parent-transaction-id>
    <account-holder>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <email>ppeter@example.com</email>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <merchant-crm-id>XWLfrzuGhpajYxFiFgNScwcLhtIOvXNxMIcrxIPTHqgroaFiPNDqMxGBXYUhMVBZ</merchant-crm-id>
    </account-holder>
    <shipping>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <shipping-method>home_delivery</shipping-method>
    </shipping>
    <card>
        <expiration-month>1</expiration-month>
        <expiration-year>2023</expiration-year>
        <card-type>mastercard</card-type>
    </card>
    <card-token>
        <token-id>5489620654931192</token-id>
        <masked-account-number>541333******1192</masked-account-number>
    </card-token>
    <ip-address>127.0.0.1</ip-address>
    <order-detail>66a3281e-ef43-537c-d9e9-aee73c41a9fc</order-detail>
    <descriptor>3DS-2 Use-Cases: Delayed Shipment - Un-Expected Dalay</descriptor>
    <notifications format="application/json">
        <notification url="http://www.webhook.site/68f1326e-311d-4ef8-a998-1c3c66cc497a"></notification>
    </notifications>
    <payment-methods>
        <payment-method name="creditcard"/>
    </payment-methods>
    <parent-transaction-amount currency="EUR">10.000000</parent-transaction-amount>
    <authorization-code>812274</authorization-code>
    <three-d>
        <cardholder-authentication-status>Y</cardholder-authentication-status>
    </three-d>
    <api-id>elastic-api</api-id>
    <provider-account-id>70003</provider-account-id>
</payment>
----
//include::{root}/auto-generated/samples/xml/CreditCard_Non3D_Preauthorization_request.xml[]
 
* _re-authorization_
When the goods have become available and are ready to be shipped the formerly authorized amount will now be reserved with a _re-authorization_. The _re-authorization_ includes in the parent-transaction-id field the transaction-id from the _authorization_.

.XML _re-authorization_ Request (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment">
    <merchant-account-id>33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <request-id>{{$guid}}</request-id>
    <transaction-type>authorization</transaction-type>
    <requested-amount currency="EUR">10.00</requested-amount>
    <parent-transaction-id>d0d04f90-1af3-4ab9-83e1-42eb5b6d3617</parent-transaction-id>
    <authorizationreason>reauthorization</authorizationreason>
    <order-detail>{{$handler}}</order-detail>
    <descriptor>{{$descriptor}}</descriptor>
</payment>
----
//include::{root}/auto-generated/samples/xml/CreditCard_Non3D_Preauthorization_request.xml[]

.XML _re-authorization_ Response (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment" self="https://api-test.wirecard.com:443/engine/rest/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1/payments/0fc5650c-c6f4-49b7-8362-8da088346562">
    <merchant-account-id ref="https://api-test.wirecard.com:443/engine/rest/config/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1">33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <transaction-id>0fc5650c-c6f4-49b7-8362-8da088346562</transaction-id>
    <request-id>1386ff35-6b7a-4dd0-af20-58d1e919c4b7</request-id>
    <transaction-type>authorization</transaction-type>
    <transaction-state>success</transaction-state>
    <completion-time-stamp>2020-02-11T12:51:19.000Z</completion-time-stamp>
    <statuses>
        <status code="201.0000" description="3d-acquirer:The resource was successfully created." severity="information"/>
    </statuses>
    <requested-amount currency="EUR">10.00</requested-amount>
    <parent-transaction-id>d0d04f90-1af3-4ab9-83e1-42eb5b6d3617</parent-transaction-id>
    <account-holder>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <email>ppeter@example.com</email>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <merchant-crm-id>XWLfrzuGhpajYxFiFgNScwcLhtIOvXNxMIcrxIPTHqgroaFiPNDqMxGBXYUhMVBZ</merchant-crm-id>
    </account-holder>
    <shipping>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <shipping-method>home_delivery</shipping-method>
    </shipping>
    <card>
        <expiration-month>1</expiration-month>
        <expiration-year>2023</expiration-year>
        <card-type>mastercard</card-type>
    </card>
    <card-token>
        <token-id>5489620654931192</token-id>
        <masked-account-number>541333******1192</masked-account-number>
    </card-token>
    <ip-address>127.0.0.1</ip-address>
    <order-detail>66a3281e-ef43-537c-d9e9-aee73c41a9fc</order-detail>
    <descriptor>3DS-2 Use-Cases: Delayed Shipment - Un-Expected Dalay</descriptor>
    <notifications format="application/json">
        <notification url="http://www.webhook.site/68f1326e-311d-4ef8-a998-1c3c66cc497a"/>
    </notifications>
    <payment-methods>
        <payment-method name="creditcard"/>
    </payment-methods>
    <parent-transaction-amount currency="EUR">10.000000</parent-transaction-amount>
    <authorization-code>424088</authorization-code>
    <api-id>elastic-api</api-id>
    <provider-account-id>70003</provider-account-id>
</payment>
----
//include::{root}/auto-generated/samples/xml/CreditCard_Non3D_Preauthorization_request.xml[]
 
* _capture_
The _capture_ of the amount refers to the _re-authorization_. The _capture_ includes in the parent-transaction-id field the transaction-id from the _re-authorization_.

.XML _capture-authorization_ Request (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment">
    <merchant-account-id>33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <request-id>{{$guid}}</request-id>
    <transaction-type>capture-authorization</transaction-type>
    <requested-amount currency="EUR">10.00</requested-amount>
    <notifications format="application/json">
        <notification url="http://www.webhook.site/68f1326e-311d-4ef8-a998-1c3c66cc497a"></notification>
    </notifications>
    <parent-transaction-id>0fc5650c-c6f4-49b7-8362-8da088346562</parent-transaction-id>
    <order-detail>{{$handler}}</order-detail>
    <descriptor>{{$descriptor}}</descriptor>
</payment>
----
//include::{root}/auto-generated/samples/xml/CreditCard_Non3D_Preauthorization_request.xml[]

.XML _capture-authorization_ Response (Successful)
[source,xml,subs=attributes+]
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<payment xmlns="http://www.elastic-payments.com/schema/payment" self="https://api-test.wirecard.com:443/engine/rest/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1/payments/f1f2c6f8-798e-45e6-a85d-a5a28f97ce4d">
    <merchant-account-id ref="https://api-test.wirecard.com:443/engine/rest/config/merchants/33f6d473-3036-4ca5-acb5-8c64dac862d1">33f6d473-3036-4ca5-acb5-8c64dac862d1</merchant-account-id>
    <transaction-id>f1f2c6f8-798e-45e6-a85d-a5a28f97ce4d</transaction-id>
    <request-id>fc65f023-5923-40ce-9868-c6fcfe72f5ea</request-id>
    <transaction-type>capture-authorization</transaction-type>
    <transaction-state>success</transaction-state>
    <completion-time-stamp>2020-02-11T12:52:35.000Z</completion-time-stamp>
    <statuses>
        <status code="201.0000" description="3d-acquirer:The resource was successfully created." severity="information"/>
    </statuses>
    <requested-amount currency="EUR">10.00</requested-amount>
    <parent-transaction-id>0fc5650c-c6f4-49b7-8362-8da088346562</parent-transaction-id>
    <account-holder>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <email>ppeter@example.com</email>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <merchant-crm-id>XWLfrzuGhpajYxFiFgNScwcLhtIOvXNxMIcrxIPTHqgroaFiPNDqMxGBXYUhMVBZ</merchant-crm-id>
    </account-holder>
    <shipping>
        <first-name>Paul</first-name>
        <last-name>Peterson</last-name>
        <address>
            <street1>978C Golf Street</street1>
            <city>Round Lake</city>
            <state>IL</state>
            <country>US</country>
            <postal-code>60073</postal-code>
        </address>
        <shipping-method>home_delivery</shipping-method>
    </shipping>
    <card>
        <expiration-month>1</expiration-month>
        <expiration-year>2023</expiration-year>
        <card-type>mastercard</card-type>
    </card>
    <card-token>
        <token-id>5489620654931192</token-id>
        <masked-account-number>541333******1192</masked-account-number>
    </card-token>
    <ip-address>127.0.0.1</ip-address>
    <order-detail>66a3281e-ef43-537c-d9e9-aee73c41a9fc</order-detail>
    <descriptor>3DS-2 Use-Cases: Delayed Shipment - Un-Expected Dalay</descriptor>
    <notifications format="application/json">
        <notification url="http://www.webhook.site/68f1326e-311d-4ef8-a998-1c3c66cc497a"></notification>
    </notifications>
    <payment-methods>
        <payment-method name="creditcard"/>
    </payment-methods>
    <parent-transaction-amount currency="EUR">10.000000</parent-transaction-amount>
    <authorization-code>424088</authorization-code>
    <api-id>elastic-api</api-id>
    <provider-account-id>70003</provider-account-id>
</payment>
----
//include::{root}/auto-generated/samples/xml/CreditCard_Non3D_Preauthorization_request.xml[]