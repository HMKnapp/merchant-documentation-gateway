//include::shortcuts.adoc[]
:payment-method: Guaranteed Invoice by {payment-provider-name}

[#PPv2_GuaranteedInvoice]
===== {payment-method}

[#PPv2_GuaranteedInvoice_General]
====== General Information

This is a reference page for _{payment-method}_. Here you find all
the information necessary for integrating this payment method into
your Hosted and Embedded Payment Page.

.Are you unfamiliar with {payment-page-v2} ({payment-page-v2-abbr})?

NOTE: Visit one of the integration guides
(<<PaymentPageSolutions_PPv2_HPP_Integration, Hosted>>,
<<PaymentPageSolutions_PPv2_EPP_Integration, Embedded>>) for a quick explanation and
a step-by-step guide before continuing.

All <<PPv2, {payment-page-v2-abbr}>> integrations share a
<<PPSolutions_PPv2_Workflow, common process flow>>  for creating payments.

Below, you find example requests for the available transaction type
<<PPv2_GuaranteedInvoice_TransactionType_authorization, _authorization_>>, 
including field lists with short descriptions.

These requests are designed for the testing environment and do not
use real information. 

NOTE: For production, you need to use production credentials. For details
contact <<ContactUs, merchant support>>.

All given requests return successful responses.

For more details on the ``redirect-url``, see 
<<PPSolutions_PPv2_ConfigureRedirects, Configuring Redirects and IPNs for {payment-page-v2-abbr}>>.

For response verification examples, see
the <<PPSolutions_PPv2_PPv2Security, {payment-page-v2-abbr} Security>>  section.

[#PPv2_GuaranteedInvoice_About]
====== About _{payment-method}_

With Guaranteed Invoice, {payment-provider-name} guarantees that merchants receive money, even if the consumer does not pay.

The consumer pays by invoice upon receipt of the goods. {payment-provider-name} pays the merchant the order amount prior to settlement with the consumer. The invoicing and collection process (including dunning) is also handled by {payment-provider-name}.

This payment method is available for *German merchants* only.

[#PPv2_GuaranteedInvoice_ProcessChain]
====== Process Chain

Every merchant needs to follow test process chains successfully in a test environment to get an approval to go live. {payment-provider-name} checks and approves the frontend/checkout and invoices (if generated and sent out by the merchant).
image:images/icons/arrow.png[click here] <<GuaranteedInvoice_ProcessChain, More information on the process chain.>> 

ifdef::env-wirecard[]

[#PPv2_GuaranteedInvoice_ConsenttoGeneralTermsandConditions]
====== Consent to General Terms and Conditions

During checkout, the consumer has to agree to {payment-provider-name}'s general terms and conditions. They have to give their consent by ticking an
appropriate checkbox.

[%autowidth]
|===
|Language |Check-box text |Correct links

|English
|I herewith confirm that I have read the https://www.wirecardbank.com/privacy-documents/datenschutzhinweise-fuer-die-wirecard-zahlarten/[privacy
notice] and https://www.wirecardbank.com/privacy-documents/zusatzliche-geschaftsbedingungen-fur-wirecard-zahlarten/[additional terms and conditions] for Wirecard payment types and that I accept their
validity.
a|
- https://www.wirecardbank.com/privacy-documents/datenschutzhinweise-fuer-die-wirecard-zahlarten/[privacy notice]: +
link to +
https://www.wirecardbank.com/privacy-documents/datenschutzhinweise-fuer-die-wirecard-zahlarten/
- https://www.wirecardbank.com/privacy-documents/zusatzliche-geschaftsbedingungen-fur-wirecard-zahlarten/[additional terms and conditions]: +
link to +
https://www.wirecardbank.com/privacy-documents/zusatzliche-geschaftsbedingungen-fur-wirecard-zahlarten/
|Deutsch
|Hiermit bestätige ich, dass ich die https://www.wirecardbank.de/privacy-documents/datenschutzhinweis-fur-die-wirecard-zahlarten/[Datenschutzhinweise]
und https://www.wirecardbank.de/privacy-documents/zusatzliche-geschaftsbedingungen-fur-wirecard-zahlarten/[zusätzlichen Geschäftsbedingungen] für Wirecard-Zahlarten zur Kenntnis genommen habe und mit deren Geltung einverstanden bin.
a|
- https://www.wirecardbank.de/privacy-documents/datenschutzhinweis-fur-die-wirecard-zahlarten/[Datenschutzhinweise]: +
link to +
https://www.wirecardbank.de/privacy-documents/datenschutzhinweis-fur-die-wirecard-zahlarten/[https://www.wirecardbank.com/privacy-documents/datenschutzhinweise-fuer-die-wirecard-zahlarten/]
- https://www.wirecardbank.de/privacy-documents/zusatzliche-geschaftsbedingungen-fur-wirecard-zahlarten/[zusätzliche Geschäftsbedingungen]:
link to
https://www.wirecardbank.de/privacy-documents/zusatzliche-geschaftsbedingungen-fur-wirecard-zahlarten/[https://www.wirecardbank.com/privacy-documents/zusatzliche-geschaftsbedingungen-fur-wirecard-zahlarten/]
|===

Make sure that the privacy notice and the additional terms and
conditions are linked properly.

endif::[]

ifndef::env-wirecard[]

[#PPv2_GuaranteedInvoice_ConsenttoGeneralTermsandConditions]
====== Consent to General Terms and Conditions

During checkout, the consumer has to agree to {payment-provider-name}'s general terms and conditions. They have to give their consent by ticking an
appropriate checkbox.

endif::[]

[#PP2_GuaranteedInvoice_AdditionalBusinessContitions]
====== Additional Business Conditions

When consumers use _{payment-method},_
payments with debt discharging effect can be made solely to {payment-provider-name}.


[#PPv2_GuaranteedInvoice_TestCredentials]
====== Test Credentials

Test Credentials for Transaction Type
<<PPv2_GuaranteedInvoice_TransactionType_authorization, _authorization_>>.

[%autowidth, cols=","]
|===
h| URI (Endpoint)
|``\https://{test-instance-hostname}/api/payment/register``
h| Merchant Account ID (MAID)
| 7d7edecb-b008-4f05-9103-308c81cf2ea2
h| Username
| 16390-testing
h| Password
| 3!3013=D3fD8X7
|===

[#PPv2_GuaranteedInvoice_TransactionType_authorization]
====== Transaction Type _authorization_

An _authorization_

- performs a creditworthiness check at the moment when consumer makes an order.
- does not trigger money transfer.

//-

[NOTE]
====
. <<PPv2_GuaranteedInvoice_TransactionType_authorization_orderItem, All Shopping basket items (order-items)>>  must be specified in every request.
. The authorization amount must match the total value of the items in the basket.
. The response for each ``authorization`` request returns the field ``descriptor``, a unique alphanumerical code identifying the authorization. This ``descriptor`` must be printed on all invoice documents and saved by
the shop (used by consumers in bank transfers; German:
"Verwendungszweck").­­
. You have to <<PPv2_GuaranteedInvoice_PostProcessingOperations, capture>> each succesful authorization on the same day the goods are dispatched.
. The period between the ``authorization`` and the capture must be at least 4 hours.

====

For a successful _authorization_ transaction

. Create an _authorization_ session (initial _authorization_ request).
. Redirect the consumer to the payment page (initial response URL).
. Highly recommended: Parse and process the payment response.

//-

<<PPv2_GuaranteedInvoice_TestCredentials, Endpoint>> for _{payment-method}_ payments.

.Initial Request

The initial request creates the payment session. If it is
successful, you receive a URL as a response which redirects the consumer to the payment confirmation form.

.Request Headers

[%autowidth, cols=","]
|===
h| Authorization
| Basic MTYzOTAtdGVzdGluZzozITMwMTM9RDNmRDhYNw==
h| Content-Type
| application/json
|===

.1. Create a Payment Session (Initial Request)

[source,json]
----
include::samples/json/PPv2GuaranteedInvoiceTransactionTypeAuthorizationRequest.json[source,json,subs=attributes+]
----

[%autowidth]
[cols="e,,,,,,"]
|===
3+| Field (JSON) | Data Type | Required/Optional | Size | Description

|merchant-account-id 2+e|value |String |Required |36 |A unique identifier assigned
to every merchant account (by {payment-provider-name}).
3+|request-id |String |Required |150 a|A unique identifier assigned by the merchant
to each request. Used when searching for or referencing it later.

You may enter any ``request-id`` that has never been used before.

As the request ID must be unique, ``{{$guid}}`` serves as a placeholder; Postman
uses it to generate a random ``request-id`` for testing.

Allowed characters:  [a-z0-9-\_]

3+|transaction-type |String |Required |n/a a|The requested transaction type. For _{payment-method}_, the transaction-type must be set to ``authorization``.

.2+|requested-amount  2+e|value |Numeric |Required |9.2 a|The full amount that is requested/contested in a transaction. The amount must be between a defined minimum value and a defined maximum value. +
2 decimal digits allowed. +
Use . (decimal point) as the separator.

2+|currency |String |Required |3 a|The currency of the requested/contested
transaction amount. Must be ``EUR``.

Format: 3-character abbreviation according to ISO 4217.

.10+|account-holder .5+e|address |street1 |String |Required | |The first line of the consumer's address street.

|state |String |Required | |The consumer's state.

|country |String |Required | |The consumer's country.

|city |String |Required | |The consumer's city.

|postal-code |String |Required | |The postal/ZIP code of the consumer's address.

2+e|first-name |String |Required | |Consumer's first name.

2+e|last-name |String |Required | |Consumer's last name.

2+e|email |String |Required | |Consumer's email address.

2+e|phone |String |Required | |Consumer's phone number.

2+e|date-of-birth |String |Required | |Consumer's date of birth. {payment-provider-name} validates the consumer's age to check if they are eligible for payment with Guaranteed Invoice.

3+|order-number |String |Required |32 v|Merchant-side order number. +
Allowed characters: [a-zA-Z0-9+]

.6+|[[PPv2_GuaranteedInvoice_TransactionType_authorization_orderItem]]order-item .2+e|name |description |String |Required | |Name of the item in the shopping basket.
|article-number |String |Required | |EAN or other merchant side article identifier.

.2+e|amount |value |Numeric |Required | |Item’s price per unit.
|currency |String |Required | |

2+|tax-rate |Numeric |Required | |Item’s tax rate per unit.

2+|quantity |Numeric |Required | |Total number of this item in the shopping basket.

3+|locale |String |Optional |2 |A 2-letter code which indicates what language the payment page is rendered in (ISO 639-1).

2+|payment-method e|name |String |Required |256 |The name of the payment method used for the transaction, i.e. ``ratepay-invoice``.

3+|notification-url |String |Optional | |The URL to which {payment-gateway} sends the transaction outcome.
3+|success-redirect-url |String |Required |2000 a|The URL to which the consumer
is redirected after a successful payment,
e.g. ``\https://{pp-redirect-url-success}``
3+|fail-redirect-url |String |Required |2000 a|The URL to which the consumer is
redirected after a failed payment,
e.g. ``\https://{pp-redirect-url-error}``
3+|cancel-redirect-url |String |Required |2000 a|The URL to which the consumer
is redirected after having canceled a payment,
e.g. ``\https://{pp-redirect-url-cancel}``
|===


.2. Redirect the Consumer to the Payment Page (Sample Response URL)

[source,json]
----
include::samples/json/PPv2GuaranteedInvoiceTransactionTypeAuthorizationRedirectURL.json[source,json,subs=attributes+]
----

[%autowidth, cols="m,v,"]
|===
|Field (JSON) v|Data Type |Description

|payment-redirect-url |String |The URL which redirects to the payment
form. Sent as a response to the initial request.
|===

At this point, you need to redirect your consumer to
``payment-redirect-url`` (or render it in an _iframe_ depending on your
<<PPv2, integration method>>).

Consumers are redirected to the payment form. There they enter their
data and submit the form to confirm the payment. A payment can be:

- successful (``transaction-state: success``),
- failed (``transaction-state: failed``),
- canceled. The consumer canceled the payment before/after submission
(``transaction-state: failed``).

//-

The transaction result is the value of ``transaction-state`` in the
payment response. More details (including the status code) can also be
found in the payment response in the ``statuses`` object. Canceled
payments are returned as _failed_, but the
``status description`` indicates it was canceled.

In any case (unless the consumer cancels the transaction on a 3^rd^ party
provider page), a base64 encoded response containing payment information
is sent to the configured redirection URL. See
<<PPSolutions_WPP_ConfigureRedirects, Configuring Redirects and IPNs for WPP>>
for more details on redirection targets after payment & transaction status
notifications.

You can find a decoded payment response example below.

.3. Parse and Process the _authorization_ Response (Decoded Payment Response)

[source,json]

----
include::samples/json/PPv2GuaranteedInvoiceTransactionTypeAuthorizationResponse.json[]
----

In addition to the request fields, the response returns the following fields:

[%autowidth]
[cols="m,,,,"]
|===
3+|Field (JSON) |Data Type |Description

3+|ip-address |String a|The internet protocol address of the account holder as
recorded by the entity receiving the transaction attempt from the account holder.
 Supported IP versions: IPv4 and IPv6.

.2+|custom-fields 2+m|field-name |String |The custom field name is ``terms-consent-checked``. The corresponding ``field-value`` indicates whether or not the consumer agreed to the <<PPv2_GuaranteedInvoice_ConsenttoGeneralTermsandConditions, General Terms and Conditions>> by ticking the appropriate checkbox.

2+|field-value |Boolean a|

- ``true``: Consumer accepted the General Terms and Conditions.
- ``false``: Consumer did not accept the General Terms and Conditions.

3+|transaction-id |String |A unique identifier assigned to every transaction.
Used when searching for or referencing it later.
3+|transaction-state |String a|The current transaction state.

Possible values:

- ``in-progress``
- ``success``
- ``failed``

//-

Typically, a transaction starts with state _in-progress_ and finishes with
state either _success_ or _failed_. This information is returned in the response
only.
3+|completion-time-stamp |DateTime a|The UTC/ISO time-stamp documents the
time and date when the transaction was executed.

Format: YYYY-MM-DDThh:mm:ss.ss (ISO).
.4+|status 2+m|code |String |Status code of the status message.

2+|description |String |The description of the transaction status message.
Click here  for a complete list of status descriptions.

2+|severity |String a|The definition of the status message.

Possible values:

- ``information``
- ``warning``
- ``error``

//-

2+|provider-transaction-id |String |A unique transaction identifier generated by the provider.

2+|payment-method |payload |String |The value of ``payload`` depends on the payment method. +
Always empty for _{payment-method}_.

3+|api-id |String |Identifier of the currently used API.
2+|device m|fingerprint |String |<<GuaranteedInvoice_DeviceFingerprint_GuaranteedInvoice, Click for a detailed fingerprint description>>.
3+|descriptor |String |The descriptor (German: “Verwendungszweck”) must be printed on all invoice documents. It must be used by the consumer on bank transfers.
|===

[#PPv2_GuaranteedInvoice_PostProcessingOperations]
====== Post-Processing Operations 
WPP is best used for one-off payments (e.g. regular, independent _authorization_ transactions) or the initial transaction in a chain of them (e.g. a first _authorization_ in a chain of recurring transactions). However, when it comes to referencing a transaction for any kind of post-processing operation - such as a capturing of one of your _authorization_ transactions - use our <<RestApi, REST API>> directly.

NOTE: Check the REST API <<link to the respective REST API page if available, {payment-method} specification>> for details on {payment-method}-specific post-processing operations

To complete a purchase, i.e. to capture an authorization, you must provide the necessary data:

- ``parent-transaction-id``: This is the transaction ID of the preceding
authorization. You can gather it from the response to a successful authorization.
- ``amount`` (can be either the total amount for capturing the full
amount, or a partial amount for a partial capture).

//-

[#PPv2_GuaranteedInvoice_JSONNVPFields]
====== JSON/NVP Field Reference

NVP equivalents for JSON fields (for migrating merchants).

Here you can:

- find the NVP equivalents for JSON fields (for migrating merchants),
- see the structure of a full request (optional fields included).

//-

[#PPv2_GuaranteedInvoice_JSONNVPFields_request]
.JSON Structure for _{payment-method}_ Requests

[source,json,subs=attributes+]
----
{
    "payment": {
        "merchant-account-id": {
        "value": "string"
        },
        "request-id": "string",
        "transaction-type": "string",
        "requested-amount": {
            "currency": "string",
            "value": "0"
        },
        "payment-methods": {
            "payment-method": [
                {
                "name": "string"
                }
            ]
        },
        "account-holder" : {
            "first-name" : "string",
            "last-name" : "string",
            "email" : "string",
            "phone" : "string",
            "date-of-birth" : "string",
            "address" : {
                "country" : "string",
                "street1" : "string",
                "city" : "string",
                "postal-code" : "string",
                "state" : "string"

        },
        "order-items" : {
            "order-item" : [ {
                "name" : "string"
                "description" : "string",
                "article-number" : "string",
                "tax-rate" : numeric,
                "quantity" : numeric,
                "amount" : {
                    "currency" : "string",
                    "value" : numeric
        },
      },
        "order-number": "string",
        "success-redirect-url": "string",
        "fail-redirect-url": "string",
        "cancel-redirect-url": "string"
    }
}
----

[%autowidth, cols="e,e,e"]
|===
|Field (NVP) |Field (JSON) |JSON Parent

|merchant_account_id |value |merchant-account-id
|request_id |request-id |payment
|transaction_type |transaction-type |payment
|requested_amount_currency |currency |requested-amount
|requested_amount |value |requested-amount
|payment_method |payment-method [ { } ]/name |payment-methods
|first_name |first-name |account-holder
|last_name |last-name |account-holder
|email |email |account-holder
|phone |phone |account-holder
|date_of_birth |date-of-birth |account-holder 
|country |address [ { } ]/ country |account-holder
|city |address [ { } ]/ city |account-holder
|postal_code |address [ { } ]/ postal-code |account-holder
|state |address [ { } ]/ state |account-holder
|orderItems[n].name |order-item [ { } ]/name |order-items
|orderItems[n].description |order-item [ { } ]/description |order-items
|orderItems[n].articleNumber |order-item [ { } ]/article-number |order-items
|orderItems[n].amount.value |amount [ { } ]/value |order-item
|orderItems[n].amount.currency |amount [ { } ] |order-items
|orderItems[n].taxRate |order-item [ { } ]/tax-rate |order-items
|orderItems[n].quantity |order-item [ { } ]/quantity |order-items
|order_number |order-number |payment
|success_redirect_url |success-redirect-url |payment
|fail_redirect_url |fail-redirect-url |payment
|cancel_redirect_url |cancel-redirect-url |payment
|===


.Response-Only Fields

[source,json]
----
{
  "payment" : {
    "custom-fields" : {
      "custom-field" : [ {
        "field-name" : "string",
        "field-value" : "boolean"
      } ]
    },
    "transaction-id" : "string",
    "transaction-state" : "string",
    "completion-time-stamp" : "string",
    },
    "statuses" : {
      "status" : [ {
        "description" : "string",
        "severity" : "string",
        "code" : "string",
        "provider-transaction-id" : "string"
      } ]
    },
    "api-id" : "string",
    "device" : {
      "fingerprint" : "string"
    },
   "descriptor": "string"
  }
}
----

[#PPv2_GuaranteedInvoice_JSONNVPFields_response]
[cols="e,e,e"]
|===
|Field (NVP) |Field (JSON) |JSON Parent

|ip_address |ip-address |payment
|field_name_1 |custom-field( {} )/ field-name |custom-fields
|field_value_1 |custom-field( {} )/ field-value |custom-fields
|transaction_id |transaction-id |payment
|transaction_state |transaction-state |payment
|completion_time_stamp |completion-time-stamp |payment
|status_severity_n |status ([ {} ])/ severity |statuses
|status_code_n |status ([ {} ])/ code |statuses
|status_description_n |status ([ {} ])/ description |statuses
|provider_transaction_id_n |status ([ {} ])/ provider-transaction-id |statuses
|api_id |api-id |payment
|device_fingerprint |fingerprint |device
|descriptor |descriptor |payment
|===

//-
