:payment-method-name: Klarna

[#KlarnaV2_TransactionTypes_refundCapture]
===== refund-capture

Use this transaction type to trigger repayment if a consumer returns all or some items. 

You can refund

* the **total order amount:** If you do not send order items within the _refund-capture_ request, the total order amount will be refunded. 
* a **partial order amount:** Send the returned order items information within the _refund-capture_ request to trigger a partial order amount.
* only authorizations that have not yet been completely captured.
//-

You cannot 

* bundle refunds. You have to create a _refund-capture_ transaction for each _capture-authorization_ transaction separately.
* change the price of the ordered items, otherwise the _refund-capture_ transaction will be rejected.
//-

////
good-will refund:  which is a
new discount item in the _refund-capture_ transaction. It can be also
used to issue change vouchers. The new order item must explicitly have
the type _discount_ in order to be processed as good-will refund,
otherwise it will be rejected as not existing item to be refunded.
- The other possibility is to add some additional shipment or handling
fees for a refund. It increases the order amount but the fee amount
itself cannot go over the total amount of the refunded items. To add
additional fees that may occur at the merchant side (shipping fee or
handling fee) merchant has to provide new order item(s) with the type
_shipment_fee_ or _handling_fee._
////

To unambiguously refer to a specific _capture-authorization_, you need the ``parent-transaction-id``, which is the ``transaction-id`` of the preceding _capture-authorization_.

[#KlarnaV2_TransactionTypes_refundCapture_Workflow]
====== _refund-capture_ Workflow

[mermaid,Klarnav2_workflow_refundAuthorization,svg,subs=attributes+]
----
sequenceDiagram
    participant M as Merchant
    participant W as WPG
    participant K as Klarna
M->>W: sends "refund-capture" request
W->>K: creates "refund-capture" transaction
note over K: processes refund
K->>W: sends refund result
W->>M: creates/sends "refund-capture" response
----

. -> Send a _refund-capture_ request. This request must contain the ``parent-transaction-id``, which is the ``transaction-id`` of the preceding _capture-authorization_.

 ** If the _refund-capture_ request does not contain order items, _{payment-gateway}_ refunds the total order amount, i.e. all order items of the preceding _capture-authorization_ transaction are refunded.
. _{payment-gateway}_ forwards the request to _{payment-method-name}_. 
. _{payment-method-name}_ returns the refund result.
. _{payment-gateway}_ sends you the _refund-capture_ response which contains the status code.
. -> Process the _refund-capture_ response.

//-

[#KlarnaV2_TransactionTypes_refundCapture_Fields]
====== _refund-capture_ Fields

The following fields are either mandatory (M) or optional (O) in the refund process.

[%autowidth]
[cols="e,,,,,"]
|===
|Field |Request |Response |Data Type |Size |Description

|merchant-account-id 
|O 
|M 
|Alphanumeric 
|36 
|A unique identifier assigned to every merchant account (by {payment-provider-name}).

|request-id 
|M
|M 
|Alphanumeric 
|36 
a|A unique identifier assigned by the merchant
to each request. Used when searching for or referencing it later.

As the request ID must be unique, ``{{$guid}}`` serves as a placeholder; Postman
uses it to generate a random ``request-id`` for testing.

Allowed characters:  ``[a-z0-9-\_]``.

|parent-transaction-id
|M
|M
|Alphanumeric 
|36
|Enter the ``transaction-id`` of the preceding _capture-authorization_.

|transaction-type 
|M 
|M 
|Alphanumeric
|30 
|The requested transaction type. Set this field to `refund-capture`.

|requested-amount  
|M
|M
|Numeric
|18,3
a|Total order amount to be resered. The number of decimal places depends on the currency. 

The requested amount must not exceed the amount of the preceding _capture-authorization_ transaction.

Use ``,`` (comma) as separator.

|[[KlarnaV2_TransactionTypes_refundCapture_Fields_requestedAmount_currency]]requested-amount@currency 
|M 
|M 
|Alphanumeric
|3 
a|The <<KlarnaV2_CountriesCurrencies, currency>> of the requested/contested
transaction amount. +
Format: 3-character abbreviation according to ISO 4217.

|order-detail
|O
|O
|Alphanumeric
|
|Detailed description of the (reason for the) refund.

|payment-methods. +
payment-method@name
|O 
|M 
|Alphanumeric
|15 
a|The name of the payment method used for the transaction. 

Possible values: 

  - ``klarna-finance`` for payment in installments (Pay later)
  - ``klarna-debit`` for _{payment-method-name}_ direct debit (Pay now) 
  - ``klarna-transfer`` for _{payment-method-name}_ bank transfer (Pay now)
  - ``klarna-paylater`` for _{payment-method-name}_ payment on invoive (Pay later)
//-

|locale	
|- 
|M 
|Alphanumeric
|5 
|A 5-letter code which indicates what <<KlarnaV2_Locales, language>> the payment page is rendered in (RFC 1766).

|transaction-id 
|-
|M 
|Alphanumeric
|36
|A unique identifier assigned for every transaction. Generated by {payment-provider-name} Used when searching for or referencing it later.

|transaction-state 
|-
|M 
|Alphanumeric
|12
a|Transaction status. +
Possible values: 

  - ``success``
  - ``failed``

//-

|completion-time-stamp
|-
|M
|DateTime
|
|The timestamp documents the time and date when the transaction was completed.

|notifications. +
notification-url 
|M 
|M 
|Alphanumeric
|256
|The URL to which _{payment-gateway}_ sends an <<GeneralPlatformFeatures_IPN_NotificationExamples, Instant Payment Notification (IPN)>> for pending reservations or the transaction outcome. It overwrites the notification URL that is set up in your merchant configuration.

5+<.>s|order-items.order-item.
s|Description of a specific order item.

|name 
|M 
|M 
|Alphanumeric
|256 
|Name of the item to be refunded.

|description 
|O 
|O 
|Alphanumeric
|1024 
|Description of the item to be refunded.

|quantity 
|M
|M
|Numeric 
|n/a  
|Total number of this item to be refunded.

|article-number 
|M 
|M 
|Alphanumeric
|256 
|EAN or other merchant-side article identifier.

|amount 
|M 
|M 
|Numeric 
|18,3 
|Item’s price per unit.  +

Use ``,`` (comma) as separator.

|amount@currency 
|M 
|M 
|Alphanumeric
|3 
|<<KlarnaV2_CountriesCurrencies, Currency>> of this item's price. Must match the <<KlarnaV2_Fields_requestedAmount_currency, order currency (requested amount currency)>>. +
Format: 3-character abbreviation according to ISO 4217.

|type
|M 
|M
|Alphanumeric
|n/a
a|Order item type. +
Possible values: 

  - ``shipment_fee``
  - ``handling_fee``
  - ``discount``
  - ``physical``
  - ``sales_tax``
  - ``digital``
  - ``gift_card``
  - ``store_credit``

//-

|tax-rate 
|O 
|O 
|Numeric
|5,2 
a|Item’s tax rate per unit in percent.

|tax-amount 
|O 
|O 
|Numeric
|5,2 
a|Item’s tax value per unit.

|discount	
|O
|O
|Numeric
|18,3 
|The discount value for one order item.  +
Use ``,`` (comma) as separator.

5+<.>s|account-holder.
s|Contains consumer data.

|date-of-birth 
|-
|O 
|Date 
|
|Consumer's date of birth. +
Format: _{payment-method-name}_ accepts only ``dd-MM-YYYY`` or ``YYYY-MM-dd``. + 
If you provide a different format, __{payment-method-name}__ prompts the consumer to enter their birth date during the payment process.

|first-name 
|- 
|O 
|Alphanumeric
|32 
|Consumer's first name.

|last-name 
|- 
|O 
|Alphanumeric
|32 
|Consumer's last name.

|email 
|- 
|O 
|Alphanumeric
|64 
|Consumer's email address.

|gender 
|
|O 
|Alphanumeric
|1 
|Consumer's gender.

|phone 
|- 
|O 
|Alphanumeric
|32 
|Consumer's phone number. +
Phone numbers need to be validated. Click <<Klarna_phoneNumberValidation, here>> for details.

5+<.>s|account-holder.address.
s|Consumer's address.

|street1 
|- 
|O 
|Alphanumeric
|128 
|Street of the consumer's address.

|street2	
|- 
|O 
|Alphanumeric
|128 
|House number of the consumer's address.	 

|city 
|- 
|O 
|Alphanumeric
|32 
|City of the consumer's address.

|country 
|- 
|M 
|Alphanumeric
|3 
|<<KlarnaV2_CountriesCurrencies, Country code>> of the consumer's address.

|postal-code 
|- 
|O 
|Alphanumeric
|16 
|Postal/ZIP code of the consumer's address.

5+<.>s|shipping. 
s|Consumer's shipping information.

|first-name 
|- 
|O 
|Alphanumeric
|32 
|First name of the recipient.  

|last-name 
|- 
|O 
|Alphanumeric
|32 
|Last name of the recipient.

|email 
|- 
|O 
|Alphanumeric
|64 
|Email address of the recipient.	

|phone 
|- 
|O 
|Alphanumeric
|32 
|The phone number of the recipient. +
Phone numbers need to be validated. Click <<Klarna_phoneNumberValidation, here>> for details.

|tracking-number
|O
|O
|Alphanumeric
|64
|The delivery tracking number for this order.

5+<.>s|shipping.address.
s|Consumer's shipping address.

|street1 
|- 
|O 
|Alphanumeric
|128 
|Street of the recipient's address.

|street2 
|- 
|O 
|Alphanumeric
|128 
|House number of the recipient's address.	 

|house-extension 
|- 
|O 
|Alphanumeric
|32 
|House extension of the recipient's address.	 

|city 
|- 
|O 
|Alphanumeric
|32 
|City of the recipient's address.

|country 
|-
|O
|Alphanumeric
|3 
|Country code of the recipient's address.

|postal-code 
|- 
|O 
|Alphanumeric
|16 
|Postal/ZIP code of the recipient's address.

5+<.>s|statuses.status.
s|Contains information on the status of a specific transaction.

|code
|-
|M
|Alphanumeric
|12
|Transaction status code.

|description
|-
|M
|Alphanumeric
|256
|Transaction status message.

|severity
|-
|M
|Alphanumeric
|20
a|The definition of the status message. Possible values:

- ``information``
- ``warning``
- ``error``

//-

|===

[#KlarnaV2_TransactionTypes_refundCapture_Samples]
====== _refund-capture_ Samples

._refund-capture_ Request
----
include::samples/xml/Klarnav2_refundCapture_request.xml[]
----

._refund-capture_ Response
----
include::samples/xml/Klarnav2_refundCapture_response.xml[]
----

