include::shortcuts.adoc[]
:payment-method-name: Klarna

[#PPv2_Klarna]
===== {payment-method-name}.

[.clearfix]
--
[.right]
image::images/11-13-klarna/klarna_logo_black.png[Klarna Logo,width=200]

_{payment-method-name}_ offers 3 payment options for consumers to pay when and how they prefer to: 

* **Pay now**: +
    - Quick and easy direct payments (direct debit, bank transfer, credit card).
    - Support for recurring payments and subscriptions.
    - Type of <<PaymentMethods_PaymentMode_OnlineBankTransfer, Online Bank Transfer>>.
* **Pay later**:
    - Payment on invoice. Consumers pay for goods or services 14 - 60 days after receipt. 
    - Type of <<PaymentMethods_PaymentMode_OfflineBankTransfer, Offline Bank Transfer>>.
* **Slice it**: +
    - Consumers pay for received goods or services in equal monthly installments.
    - Type of <<PaymentMethods_PaymentMode_OfflineBankTransfer, Offline Bank Transfer>>.

_{payment-method-name}_ takes full credit and fraud risk and guarantees payments.
--

.Countries and Currencies
////
[cols="20h,80"]
|===
|Countries    
|Sweden, Norway, Finland, Denmark, UK, Germany, Austria, Netherlands, Switzerland

|Currencies   
|CHF, DKK, EUR, GBP, NOK, SEK
|===
////
[%autowidth]
[cols=","]
|===
|Country |Payment Option Availability

|Austria
|Pay now, Pay later
|Denmark
|Pay now, Pay later, Slice it
|Finland
|Pay now, Pay later, Slice it
|Germany
|Pay now, Pay later, Slice it
|Netherlands
|Pay now, Pay later
|Norway	
|Pay now, Pay later, Slice it
|Sweden	
|Pay now, Pay later, Slice it
|Switzerland
|Pay now, Pay later
|UK	
|Pay now, Pay later, Slice it
|===

[#PPv2_Klarna_Currencies]
.Supported locale/country/currency combinations:

[%autowidth]
[cols=",,"]
|===
|locale |Purchase Country |Purchase Currency

|da-dk
|DK
|DKK
|de-at
|AT
|EUR
|de-de
|DE
|EUR
|en-gb
|GB
|GBP
|fi-fi
|FI
|EUR
|nl-nl
|NL
|EUR
|no-no
|NO
|NOK
|sv-se
|SE
|SEK
|===

[#PPv2_Klarna_GeneralInformation]
====== General Information

include::include/ppv2-general-information.adoc[]

Below, we provide a sample request/sample requests for the available transaction type <<PPv2_Klarna_TransactionType_authorization, authorization>>, including a field list with short descriptions.

include::include/ppv2-general-information-2.adoc[]


[#PPv2_Klarna_Transactions_authorization]
====== Transaction Type _authorization_

With _{payment-method-name}_ you can use the transaction types _authorization_ and _auto-sale_, which both trigger an _authorization_.

An _authorization_ reserves the specified amount from the account holder’s bank account for a later transfer. It performs an order risk check and an order reservation. Once an order is reserved, the payment is guaranteed.

[#PPv2_Klarna_TestCredentials]
====== Test Credentials

[cols="20h,80"]
|===
|URL (Endpoint)
|``\https://{pp-test-endpoint}``

|Merchant Account ID (MAID)
a| //insert MAID or Please <<ContactUs, contact merchant support>> for complete test credentials.

|Username
a| //insert username

|Password
a| // insert password or Please <<ContactUs, contact merchant support>> for complete test credentials.

|Secret Key (used for response verification)
a| // insert Secret Key or Please <<ContactUs, contact merchant support>> for complete test credentials.
|===

////
INCLUDE THIS SECTION IF REQUIRED
[#PPv2_{payment-method-name}_TestCredentials_Additional]
.Test Credentials for the _{payment-method-name}_ Environment/ .Banking Credentials

[cols="20h,80"]
|===
|User Name/ IBAN/ ...
|

|Password/ BIC/ ...
|
|===
////


[#PPv2_Klarna_Samples]
====== Sample Workflow
====
*For a successful transaction:*

. Create a payment session (initial request).
. Redirect the consumer to the payment page (initial response URL).
. Highly recommended: Parse and process the payment response.

//-
====
We provide JSON examples for each step of this process. You can find them below.

.Request Headers
[cols="20h,80"]
|===
|Authorization
a| Use username and password as given in your {payment-provider-name} contract to _Base64_ encode the authorization.

For example for `user:password` the authorization header is:
[source]
----
Authorization: Basic 
----
|Content-Type
a|
For _JSON_ requests the content type header is:
[source]
----
Content-Type: application/json;charset=UTF-8
----
|===


[#PPv2_Klarna_TransactionType_auth_Create]
.1. Create a Payment Session (Initial Request)

You can use the following sample for transaction type ``authorization`` or ``auto-sale``.

////
[source,json]
----
//insert sample here
----
////
////
Please adapt the following field table:
- Include only fields that are shown in the request.
- Order the fields by the sequence in which they appear in the request.
- Use only datatypes as indicated in the merging table. See: "templates > fields > datatypes.adoc".
- Check cardinality and size.
- Adapt description. Please give preference to PP v2 descriptions, if available.
Please expand the table as is needed. If possible, please add fields also to this template to make life easier for the other writers.
////

//It may be necessary to format the table a little bit differently, e.g. 4+|Field (JSON), etc.

[%autowidth]
[cols="m,,,,,,,"]
|===
4+s|Field (JSON) s|Data Type s|Required/ +
Optional s|Size s|Description

|merchant-account-id 3+m|value |String |Required |36 |A unique identifier assigned
to every merchant account (by {payment-provider-name}).
4+|request-id |String |Required |150 a|A unique identifier assigned by the merchant
to each request. Used when searching for or referencing it later.

You may enter any ``request-id`` that has never been used before.

As the request ID must be unique, ``{{$guid}}`` serves as a placeholder; Postman
uses it to generate a random ``request-id`` for testing.

Allowed characters:  ``[a-z0-9-\_]``.

4+|transaction-type |String |Required |30 a|The requested transaction type. Available transaction types for _{payment-method-name}_:

- `authorization`
- `auto-sale`
//-

.2+|requested-amount  
3+m|[[PPv2_Klarna_Fields_requestedAmount_currency]]currency |String |Required |3 a|The <<PPv2_Klarna_Currencies, currency>> of the requested/contested
transaction amount. +
Format: 3-character abbreviation according to ISO 4217.
3+m|value |Numeric |Required |18.3 a|The full amount that is requested/contested in a transaction. The number of decimal places depends on the currency. +
The requested amount must be equal to the amount sum of all order items.

Use ``.`` (decimal point) as separator.

.11+|account-holder 3+m|date-of-birth |String |Optional |n/a |Consumer's date of birth. +
Format: Klarna accepts only ``dd-MM-YYYY`` or ``YYYY-MM-dd``. If you provide a different format, _Klarna_ prompts the consumer to enter their birth date during the payment process.

3+m|first-name |String |Optional |32 |Consumer's first name.

3+m|last-name |String |Optional |32 |Consumer's last name.

3+m|email |String |Optional |64 |Consumer's email address.

3+m|gender |String |Optional |1 |Consumer's gender.

3+m|phone |String |Optional |32 |Consumer's phone number. Click <<PPv2_Klarna_phoneNumberValidation, here>> for details.

.5+m|address 2+m|street1 |String |Optional |128 |Street of the consumer's address.

2+|street2	|String |Optional |128 |House number of the consumer's address.	 

2+|city |String |Optional |32 |City of the consumer's address.

2+|country |String |Required |3 |Country code of the consumer's address.

2+|postal-code |String |Optional |16 |Postal/ZIP code of the consumer's address.

.10+|shipping 3+m|first-name |String |Optional |32 |First name of the recipient.  
3+|last-name |String |Optional |32 |Last name of the recipient.

3+|email |String |Optional |64 | Email address of the recipient.	

3+|phone |String |Optional |32 |The phone number of the recipient. Phone numbers need to be validated. Click <<PPv2_Klarna_phoneNumberValidation, here>> for details.

.6+m|address 2+m|street1 |String |Optional |128 |Street of the recipient's address.

2+|street2 |String |Optional |128 |House number of the recipient's address.	 

2+|house-extension |String |Optional |32 |House extension of the recipient's address.	 

2+|city |String |Optional |32 |City of the recipient's address.

2+|country |String |Optional |3 |Country code of the recipient's address.

2+|postal-code |String |Optional |16 |Postal/ZIP code of the recipient's address.

4+|order-number	|String |Optional |255 |Order number of the merchant. If set, it shows as "order number" on Klarna's confirmation page.

4+|locale	|String |Required |5 |Customer's locale according to RFC 1766.	E.g. ``en-us`` for US English, ``en-gb`` for British English and ``sv-se`` for Swedish (in Sweden).

.9+|order-items .9+m|order-item 2+m|quantity |Numeric |Required |n/a  |Total number of this item in the shopping basket.

2+m|article-number |String |Optional |256 |EAN or other merchant side article identifier.

2+m|name |String |Required |256 |Name of the item in the shopping basket.

.2+m|amount m|value |Numeric |Required |18.3 |Item’s price per unit.  +

Use ``.`` (decimal point) as separator.

|currency |String |Required |3 |<<PPv2_Klarna_Currencies, Currency>> of this item's price. Must match the <<PPv2_Klarna_Fields_requestedAmount_currency, order currency (requested amount currency)>>. +
Format: 3-character abbreviation according to ISO 4217.

2+|tax-rate |Numeric |Optional |5.2 |Item’s tax rate per unit in percent. *Required* if tax-amount is specified.

2+|tax-amount |Numeric |Optional |5.2 |Item’s tax value per unit. *Required* if tax-rate is specified.

2+|discount	|Numeric |Optional	|18.3 |The discount value for one order item.  +

Use ``.`` (decimal point) as separator.

2+|type	|String |Optional |n/a a|Order item type.

Possible values: 

  - ``shipment_fee``
  - ``handling_fee``
  - ``discount``
  - ``physical``
  - ``sales_tax``
  - ``digital``
  - ``gift_card``
  - ``store_credit``

//-

If not specified, ``type`` is treated as a regular article.

4+|notification-url |String |Optional |256|The URL to which _{payment-gateway}_ sends the transaction outcome.

4+|success-redirect-url |String |Required |2000 a|The URL to which the consumer
is redirected after a successful payment,
e.g. ``\https://{pp-redirect-url-success}``
4+|fail-redirect-url |String |Required |2000 a|The URL to which the consumer is
redirected after a failed payment,
e.g. ``\https://{pp-redirect-url-error}``
4+|cancel-redirect-url |String |Required |2000 a|The URL to which the consumer
is redirected after having canceled a payment,
e.g. ``\https://{pp-redirect-url-cancel}``

|payment-methods 2+m|payment-method m|name |String |Required |15 a|The name of the payment method used for the transaction. 

Possible values: 

  - ``klarna-sliceit`` for payment in installments (Pay later)
  - ``klarna-debit`` for Klarna direct debit (Pay now). 
  - ``klarna-transfer`` for Klarna bank transfer (Pay now).
  - ``klarna-later`` for Klarna payment on invoive (Pay later).
//-

|===

////
to be confirmed
[#PPv2_Klarna_phoneNumberValidation]
==== Phone Number Validation

Both the consumer's phone number and the
phone number that corresponds to the shipping address are mandatory. +

include::include/Klarna-phoneNumberValidation.adoc[]
////

[#PPv2_Klarna_TransactionType_auth_Redirect]
.2. Redirect the Consumer to the Payment Page (Sample Response URL)
////
[source,json]
----
insert redirect-url here
----
//// 
[%autowidth, cols="m,,"]
|===
| Field (JSON) | Data Type | Description

|payment-redirect-url 
|String 
|The URL which redirects to the payment
form. Sent as a response to the initial request.
|===

include::include/ppv2-redirect-instructions.adoc[]

[#PPv2_Klarna_TransactionType_auth_Response]
.3. Parse and Process the Payment Response (Decoded Payment Response)
//// 
[source,json]
----
//insert decoded payment response here
----
//// 
////
Please adapt the following field table:
- Include only fields that are shown in the payment response.
- Order the fields by the sequence in which they appear in the payment response.
- Use only datatypes as indicated in the merging table. See: "templates > fields > datatypes.adoc".
- Adapt description (give PPv2 descriptions preference).
- Please expand the table as is needed. If possible, please add fields also to this template to make life easier for the other writers.
- If you rephrase descriptions for fields (part of this template or not), please notify Karin Kraus.

NOTE: It's not necessary to include Cardinality and Size in the response table.
////

In addition to the request fields, the response returns the following fields:

[%autowidth, cols="m,,,"]
|===
2+| Field (JSON) | Data Type | Description

2+|transaction-id 
|String 
|A unique identifier assigned for every transaction. Used when searching for or referencing it later.

2+|transaction-state 
|String 
a|The current transaction state. +
Possible values:

- ``in-progress``
- ``success``
- ``failed``

//-

Typically, a transaction starts with state ``in-progress`` and finishes with state either ``success`` or ``failed``. This information is returned in the response only.

2+m|completion-time-stamp
|Timestamp
|The UTC/ISO time-stamp documents the time & date when the transaction was executed. +
Format: ``YYYY-MM-DDThh:mm:ss`` (ISO).

.6+|status 
m|description 
|String 
|The description of the transaction status message.

|severity    
|String 
a|The definition of the status message. Possible values:

- ``information``
- ``warning``
- ``error``

//-

|code 
|String 
|Status code of the status message.

|provider-code 
|String 
|Original Klarna error code.

|provider-message 
|String 
|Error message to be shown to the end-consumer as required by Klarna.

|provider-transaction-id 
|String 
|Klarna reservation number.

2+|api-id       
|String 
|Identifier of the currently used API.
|===

[#PPv2_Klarna_PostProcessing]
====== Post-Processing Operations 

{payment-page-v2-abbr} for _Klarna_ can be used for a first _authorization_ in a chain of recurring transactions. However, when it comes to referencing a transaction for any kind of post-processing operation - such as a _capture_ or _void_ of one of your _authorization_ transactions - use our <<RestApi, REST API>> directly.

IMPORTANT: Check the REST API <<Klarna, {payment-method-name} specification>> for details on {payment-method-name}-specific post-processing operations.

////

[#PPv2_Klarna_JSONFields]
include::include/ppv2-apm-optional-fields.adoc[]

[#PPv2_Klarna_JSONNVPReference]
include::include/ppv2-apm-json-nvp-reference.adoc[]

////