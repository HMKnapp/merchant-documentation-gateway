[#GeneralPlatformFeatures]
== General Platform Features

[#GeneralPlatformFeatures_CrossRef]
=== Cross-Referencing

[#GeneralPlatformFeatures_CrossMerchant]
==== Merchant Referencing

It is possible to enable cross payment account references for a merchant
in _{payment-gateway}._ It means a transaction from the merchant
account A can reference another one from the merchant account B if its
processing user has access rights also to the merchant account A. This
is a typical scenario for marketplace portals where a consumer can allow
to reuse his payment instrument for the further orders without the new
authentication process (so-called one-click-payment).

[#GeneralPlatformFeatures_CrossMerchant_Setup]
===== Merchant Setup

It is possible to reference a previous transaction using a different
merchant account.

[#GeneralPlatformFeatures_CrossMerchant_Setup_Precondition]
====== Precondition

The general rule is:

- The processing user used in the referencing transaction must have
access rights to the merchant account of the referenced transaction.
- The access rights to a particular merchant account for the given
processing user must be established on the ACL level.

//-

In order to enable the cross reference feature for a merchant account
the following global merchant parameter must be set to true:
*global.crossreference.enabled*

In order to see the cross referenced transactions in _{enterprise-portal-abbr}_, the _{enterprise-portal-abbr}_ user
must also be granted to access the data of the referenced merchant
account. If this is not the case, the cross referenced transactions are
not shown inside the payment details list. i.e. the user cannot see the
transaction data of other merchants even if their transactions are
referencing the transactions of the others. This is a default setup
situation for a merchant _{enterprise-portal-abbr}_ user.

The billing logic for the cross referenced transactions is unchanged.
The cross referenced transactions are billed for the corresponding
merchant account used in the payment request.

The merchant reconciliation report is unchanged as well. The cross
referenced transactions are reported inside the reconciliation file for
the corresponding merchant account.

[#GeneralPlatformFeatures_CrossMerchant_Samples]
===== Samples

[#GeneralPlatformFeatures_CrossMerchant_Samples_Initial]
====== Initial Transaction

NOTE: Note that the "periodic" attribute must be selected to mark which
transaction is the first and will be referenced later.

[#GeneralPlatformFeatures_CrossMerchant_Samples_Initial_Xml]
.XML get-url Request for i.e. "iDEAL"

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_get-url_request__installment_first_72d9c4.xml[]
----

.XML get-url Response for i.e. "iDEAL"

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_get-url_response__installment_first_8b4f66.xml[]
----

.XML Debit Notification for iDEAL

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_debit_notification__installment_first_08e109.xml[]
----

[#GeneralPlatformFeatures_CrossMerchant_Samples_Initial_Json]
.JSON get-url Request for i.e. "iDEAL"

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossMerchantSamplesInitialJson_JSON_GetUrlRequestForiDEAL.json[]
----

.JSON get-url Response for i.e. "iDEAL"

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossMerchantSamplesInitialJson_JSON_GetUrlResponseForiDEAL.json[]
----

[#GeneralPlatformFeatures_CrossMerchant_Samples_Recurring]
====== Recurring Transaction

NOTE: This is a request for SEPA Credit where periodic type is "recurring".
This means that this is a referencing payment. Please note that the
"parent-transaction-id" is the same as the one from the response of the
"first" (parent) transaction.

[#GeneralPlatformFeatures_CrossMerchant_Samples_Recurring_Xml]
.XML SEPA Credit Request Cross-Merchant Payment

[source,xml,subs=attributes+]
----
include::samples/xml/sepacredit_credit_request__recurring_recurring_3aa87578.xml[]
----

.XML SEPA Credit Response Cross-Merchant Payment

[source,xml,subs=attributes+]
----
include::samples/xml/sepacredit_credit_response__recurring_recurring_3aa87578.xml[]
----

.XML SEPA Credit Notification (Successful)

[source,xml,subs=attributes+]
----
include::samples/xml/sepacredit_credit_notification_success_recurring_recurring.xml[]
----

[#GeneralPlatformFeatures_CrossMerchant_Samples_Recurring_Json]
.JSON SEPA Credit Request Cross-Merchant Payment

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossMerchantSamplesRecurringJson_JSON_SEPA_CreditRequestCrossMerchantPayment.json[]
----

.JSON SEPA Credit Response Cross-Merchant Payment

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossMerchantSamplesRecurringJson_JSON_SEPA_CreditResponseCrossMerchantPayment.json[]
----
[#GeneralPlatformFeatures_CrossPayment]
==== Payment Methods

Cross-Payment-Methods Referencing helps to reduce fraud in recurring
payments, because the merchant can reference two payment methods.

The initial transaction has to be performed with a method that requires
access credentials from the customer.

With the referencing of two payment methods the merchant can avoid that
a SEPA Direct Debit transaction, if used as initial
transaction, is returned after he has already provided the consumer with
the purchased goods or services.

The main reasons for returned SEPA Direct Debit transaction are:

- "Bank account not existing"
- "Invalid bank data"
//-

Cross-Payment-Methods Referencing is available, when the merchant has

- several online banking payment methods configured within MAID.
- installed _{payment-gateway}_ backend and
Payment Page integrations.
//-

Cross-Payment-Methods Referencing is executed in two steps:

- The initial transaction is placed by the customer actively via one of
the supported online banking payment methods:
* Sofort.
* iDEAL
* giropay
* eps-Überweisung
//-

If the initial transaction is successful, the bank details IBAN and BIC
are saved in the database, but not returned in the response.

NOTE: Not every bank provides bank account data. _{payment-gateway}_
can only process bank account data if provided by the bank.

- The subsequent transaction is a SEPA Direct Debit transaction.
The merchant receives a transaction ID from the initial transaction
which is used later to place a referenced SEPA Direct Debit transaction
without knowing the bank account details as they are automatically
connected to the transaction ID.

This functionality allows e.g. easier subscription management.

[WARNING]
====
 - All mandatory SEPA Direct Debit transaction fields must be provided in
the initial transaction so that they can be used in the subsequent SEPA
Direct Debit transaction. Mandatory SEPA fields are:
* Mandate ID,
* Mandate Signature Date
* Creditor ID
- The initial transaction must have a sequence type "first" to avoid a
SEPA Direct Debit transaction with the sequence type "recurring" to
be rejected by the system.
- The subsequent transaction requires the sequence type "recurring".
====

A clear position for the "periodic" tag cannot be established. It can be
set either <<GeneralPlatformFeatures_CrossPayment_Samples_Initial, in the initial transaction>> iDEAL
or <<GeneralPlatformFeatures_CrossPayment_Samples_Subsequent, in the subsequent transaction>> within
the SEPA Direct Debit.

The advantages, setting it in the subsequent transaction are:

- Integration of original payment method (e.g. iDEAL, Sofort., …) does
not need to be amended.
- If you are using SEPA as an additional payment option, the behavior
where to send the periodic tags is identical.
//-

NOTE: API Endpoint for referenced transactions for alternative payment methods
is always:
\https://{test-instance-hostname}/engine/rest/payments

[#GeneralPlatformFeatures_CrossPayment_Samples]
===== Samples

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial]
====== Periodic In Initial Transaction

This section describes a set of requests and responses in which the
"periodic" tag is set right in the beginning, in the _Request Initial iDEAL_.

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_Xml]
.XML get-url Request Initial iDEAL

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_get-url_request__installment_first_f11a91.xml[]
----

.XML get-url Response Initial iDEAL

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_get-url_response__installment_first_7f38b0.xml[]
----

.XML Debit Notification for Initial iDEAL

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_debit_notification__installment_first_e4e266.xml[]
----

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_Json]
.JSON get-url Request Initial iDEAL

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossPaymentSamplesInitialJson_JSON_GetUrlRequestInitialiDEAL.json[]
----

.JSON get-url Response Initial iDEAL

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossPaymentSamplesInitialJson_JSON_GetUrlResponseInitialiDEAL.json[]
----
[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_RecurringIdeal]
====== Recurring Transaction Referencing iDEAL Payment

NOTE: Referenced SEPA payment does not contain mandatory fields in the
request as these are taken from the initial iDEAL payment based on
parent transaction ID.

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_RecurringIdeal_Xml]
.XML SEPA Direct Debit Request Following

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_request__recurring_recurring_42d9e5e4.xml[]
----

.XML SEPA Direct Debit Response Following (Successful)

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_response_success_recurring_recurring_b8b27f18.xml[]
----

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_RecurringIdeal_Json]
.JSON SEPA Direct Debit Request Following

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossPaymentSamplesInitialRecurringIdealJson_JSON_SEPA_DirectDebitRequestFollowing.json[]
----

.JSON SEPA Direct Debit Response Following (Successful)

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossPaymentSamplesInitialRecurringIdealJson_JSON_SEPA_DirectDebitResponseFollowingSuccessful.json[]
----

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_RecurringSepa]
====== Recurring Transaction Referencing SEPA Credit

NOTE: This scenario is for a cross-payment-methods referenced SEPA Credit
transaction.

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_RecurringSepa_Xml]
.XML SEPA Credit Request Following

[source,xml,subs=attributes+]
----
include::samples/xml/sepacredit_credit_request__recurring_recurring_96468896.xml[]
----

.XML SEPA Credit Response Following

[source,xml,subs=attributes+]
----
include::samples/xml/sepacredit_credit_response__recurring_recurring_96468896.xml[]
----

[#GeneralPlatformFeatures_CrossPayment_Samples_Initial_RecurringSepa_Json]
.JSON SEPA Credit Request Following

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossPaymentSamplesInitialRecurringSepaJson_JSON_SEPA_CreditRequestFollowing.json[]
----

.JSON SEPA Credit Response Following

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeaturesCrossPaymentSamplesInitialRecurringSepaJson_JSON_SEPA_CreditResponseFollowing.json[]
----

[#GeneralPlatformFeatures_CrossPayment_Samples_Subsequent]
===== Periodic In Subsequent Transaction

This section describes a set of requests and responses in which the
"periodic" tag is set at a subsequent request, the _SEPA Debit Recurring_ #1.

[#GeneralPlatformFeatures_CrossPayment_Samples_Subsequent_Xml]
.XML debit Request Initial iDEAL

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_debit_request_.xml[]
----

.XML debit Response Initial iDEAL

[source,xml,subs=attributes+]
----
include::samples/xml/ideal_debit_response_.xml[]
----

NOTE: Receive Notification to get the transaction ID from the iDEAL debit to
use as reference for SEPA transactions.

.XML SEPA Credit Request

[source,xml,subs=attributes+]
----
include::samples/xml/sepacredit_credit_request__0ceed077.xml[]
----

.XML SEPA Credit Response

[source,xml,subs=attributes+]
----
include::samples/xml/sepacredit_credit_response__0ceed077.xml[]
----

.XML SEPA Direct Debit Request Recurring #1

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_request__recurring_first_0ceed077.xml[]
----

.XML SEPA Direct Debit Response Recurring #1

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_response__recurring_first_0ceed077.xml[]
----

.XML SEPA Direct Debit Request Recurring #2

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_request__recurring_recurring_aaf7d691_930818.xml[]
----

.XML SEPA Direct Debit Response Recurring #2

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_response__recurring_recurring_aaf7d691_0afa2e.xml[]
----

.XML SEPA Direct Debit Request Recurring #3

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_request__recurring_recurring_aaf7d691_920542.xml[]
----

.XML SEPA Direct Debit Response Recurring #3

[source,xml,subs=attributes+]
----
include::samples/xml/sepadirectdebit_debit_response__recurring_recurring_aaf7d691_278830.xml[]
----

[#GeneralPlatformFeatures_IPN]
=== Instant Payment Notification


[#GeneralPlatformFeatures_IPN_Introduction]
==== Introduction

The _{payment-gateway}_ has a built-in _notification_ capability.
An _Instant Payment Notification_ (IPN) informs the merchant about the
final status of a transaction.

There are two types of notifications:

- *HTTP(S)* (Web Server POST)
- *SMTP* (Email prefixed with 'mailto')
//-

The following formats are currently supported:

- application/x-www-form-urlencoded
- application/xml
- application/json
- application/json-signed
//-

[#GeneralPlatformFeatures_IPN_Configuration]
==== Configuration

When the merchant wants to receive a notification, he can either

- specify a URL as part the merchant account setup; or
- include either an email address or a URL as part of each transaction
request
//-

[NOTE]
====
- The definition of URL and format type in the transaction request
overwrites the configured definition in the merchant account setup.
- Only those notifications sent via URL contain a signature.
====

For request based IPN configuration, the request should contain the IPN
notifications element.

[WARNING]
====
- Please note that configuring an IPN is not a Mandatory setup but
recommended.
- In case a notification address has changed, it is the responsibility
of the merchant
* to keep the address up to date
* to request a Firewall Change Request on the merchant's system so that
the firewall will accept the new address. The new notification addresses
can be called up at our <<ContactUs, Merchant Support>>.
- The IPN is using XML Digital Signatures, as defined here:
https://www.w3.org/TR/xmldsig-core/
* The possibility of using this is already integrated in Java as
described here:
https://docs.oracle.com/javase/8/docs/technotes/guides/security/xmldsig/XMLDigitalSignature.html
* Oracle also provides a sample code in Java to validate a signed XML
here:
https://docs.oracle.com/javase/8/docs/technotes/guides/security/xmldsig/Validate.java
====

[NOTE]
====
In case there is no format specified in the request then the format
specified in the merchant configuration is used. If there is no IPN
format in the configuration then NVP response is used for <<PP_RedirectUrlsIPNs, HPP/EPP requests>> or
application/xml for others by default.

Be aware that just *one* notification format can be set for all
notifications sent to the specified URLs.
====

[#GeneralPlatformFeatures_IPN_Json]
===== Request a Notification in JSON Format

The following example shows how the _{payment-gateway}_ can be
configured to send notifications as JSON format:

.Signed JSON Notifications
NOTE: To request an ``application/json-signed`` notification, switch the
format value. Compared to the default JSON notification, signed
notifications are base64 encoded and include a security signature: this
means you can verify that the notification comes from Wirecard, but need
to decode it before you can see its content.

``<notifications format="application/json>``


.XML Request (determines notification in JSON format)

[source,xml,subs=attributes+]
----
include::samples/xml/generic_debit_notification__96ffdc.xml[]
----

The notification will look like this:

.JSON Notification

[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeatures_IPN_Json_JSON_Notification.json[]
----

.application/JSON-signed Notification Example
[source,json,subs=attributes+]
----
include::samples/json/GeneralPlatformFeatures_IPN_Json_applicationJSONSignedNotificationExample.json[]
----

.Verifying the Notification Signature

To verify a signed notification, check the signature data against the
Secret Key you received during merchant configuration:

[source, java]
----
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import javax.xml.bind.DatatypeConverter;

...

private String merchantSecretKey = "merchantSecretKey";

public boolean isValidSignature(String responseBase64, String responseBase64Signature, String responseSignatureAlgorithm) throws Exception {
    Mac mac = Mac.getInstance(responseSignatureAlgorithm);
    mac.init(new SecretKeySpec(merchantSecretKey.getBytes("UTF-8"), responseSignatureAlgorithm));
    return responseBase64Signature != null && responseBase64Signature.equals(DatatypeConverter.printBase64Binary(mac.doFinal(responseBase64.getBytes("UTF-8"))));
}
----

[#GeneralPlatformFeatures_IPN_Html]
===== Request a Notification in HTML Format

``<notifications format="application/html">``

image:images/08-general-platform-features/HTML-Notification.png[HTML Notification]

[#GeneralPlatformFeatures_IPN_Xml]
===== Request a Notification in XML Format

``<notifications format="application/xml">``


.Notification in XML Format
[source,xml,subs=attributes+]
----
include::samples/xml/creditcard_purchase_notification_.xml[]
----

It is possible to set up conditional notifications based on the state of
the transaction.  For example, it is possible to instruct a notification
to only occur on 'failed' or 'successful' transactions.

[cols="10,10,10,10,50"]
|===
|Notification Type  | Notification Tag in Request     | Possible Extensions of URL  | Ports         | Possible Extensions of ``transaction-state``

|HTTP(S)            | ``URL``, ``transaction-state``  | any configured URL          | 80, 443, 5500 | if _URL_ <> empty and _`transaction-state`_ = empty all notifications go to that URL or if _URL_ <> empty and _`transaction-state`_ <> empty depending on the _transaction-state_ (success, failed, in-progress, etc) the notification goes to the corresponding _URL_.
|SMTP               | ``URL``, ``transaction-state``  |                             |               | if _URL_ <> empty and ``transaction-state`` = empty all notifications go to that URL (Email address prefixed with 'mailto'). OR if _URL_ <> empty and ``transaction-state`` <> empty depending on the ``transaction-state`` (success, failed, in-progress, etc) the notification goes to the corresponding _URL_ (Email address prefixed with 'mailto').
|===



A request, which defines a URL to be used, when the payment process will fail:

.XML Request with different URL for failed transactions
[source,xml,subs=attributes+]
----
include::samples/xml/generic_debit_request__edeec5.xml[]
----

[#GeneralPlatformFeatures_IPN_NotificationExamples]
===== Notification Examples

.Credit Card Payment
[source,xml,subs=attributes+]
----
include::samples/xml/GeneralPlatformFeatures_IPN_NotificationExamples_CreditCardPayment.xml[]
----

.Alternative Payment Methods
[source,xml,subs=attributes+]
----
include::samples/xml/generic_debit_notification__596c76.xml[]
----

NOTE: Note that the "amount" value for some alternative payment notifications
contains 6 minor digits.

[#GeneralPlatformFeatures_IPN_Content]
==== Content of the Notification

The content of the notification depends on the status of the response
_{payment-gateway}_ receives from the provider.

|===
|{payment-gateway-abbr} receives... |{payment-gateway-abbr} sends notification:...

|a successful response
|_Success_ <<StatusCodes, Return Code and Transaction Status>>

|a failure response
|_Failure_ <<StatusCodes, Return Code and Transaction Status>>

|a timeout from provider |_Failure_ with error code (e.g. 500.1051)

|no info from provider |_Failure_ with error code 500.1052, if {payment-gateway-abbr} runs
in its internal timeout
|===

Credit Card IPNs are not encoded and non Credit Card IPNs are mostly
Base64 encoded, but there are variations possible. The variations depend
on the payment methods.

For each notification type it is possible to add more than one
recipient. Copy the tag and add a different URL.

In the following example, the transaction will notify the merchant's
site for a failed transaction and send all results to an email address.

[#GeneralPlatformFeatures_IPN_Transaction]
===== Notification Transaction Types

The table below defines the expected transaction type in the
notification after a specific request/response.
[%autowidth]
|===
|Request/Response Transaction Type |Possible Notification Transaction Type

|authorization |deposit
|get-url |debit, debit-return
|pending-credit |credit, credit-return, deposit
|pending-debit |debit, debit-return, deposit
|refund-request |refund-debit
|===


[#GeneralPlatformFeatures_IPN_Delay]
==== Notification Delay

In some cases the _{payment-gateway}_ ({payment-gateway-abbr}) may send a delayed
IPN.

This may occur due to one of the following reasons:

- Some payment method providers have longer processing periods than
others
- Communication delays caused by:
* downtime of the provider's system
* a workflow which has a fixed waiting time, at the _{payment-gateway}_ as well as the provider.
* the merchant has sent an incorrect ID. In that case _{payment-gateway}_ will send a 404 message, stating that the transaction is not
available.

//-

[#GeneralPlatformFeatures_IpValidation]
=== IP Validation

A merchant can send his consumer's IP address via an API request to the
_{payment-gateway}_.

_{payment-gateway}_ then validates this IP address. This IP
validation process can be enabled and disabled in the merchant's setup.


|===
|Loopback Address, "127.0.0.1" |Loopback Address: "::1"
|Private IP: "192.168.0.1" |Regular IP:"32b1:953e:207a:1d36:24bf:9244:20a0:7cea"
|Public IP: "8.8.8.8" |Compressed IP: "2001:4860:4860::8888"
|  |Expanded IP: "2001:4860:4860:0000:0000:0000:0000:8888"
|  |IPv4 Compatible (or compat): "::8.8.8.8"
|  |IPv4 Mapped IP: "::ffff:8.8.8.8"
|===

[#GeneralPlatformFeatures_RedirectURL]
=== Redirect-URL

A payment process needs a redirect-URL. If no redirect-URL is defined at
all, the transaction will not be processed.

The merchant can send a redirect URL in case of a successful, a
cancelled or a failed transaction. Depending on the result of the
transaction the consumer will be redirected to the corresponding page of
the merchant's environment.

The redirect-URLs can be configured either on MAID level or they can be
sent individually with each request.

When the merchant configures the redirect-URLs in the MAID, they don't
have to be present in the request. The redirect-URLs are automatically
loaded from the MAID configuration.

When the merchant determines the redirect-URLs in the request, the
request's redirect-URLs overwrite the MAID configuration for that
particular transaction.

The merchant can determine up to three different redirect-URLs in one request.
In that case the merchant can determine one success-URL, one for failure and
one cancellation-URL.

[#GeneralPlatformFeatures_RedirectURL_MAID]
==== Configured in MAID

In this request the redirect-URLs are configured on MAID level.

.General Request Sample for Redirect-URL

[source,xml,subs=attributes+]
----
include::samples/xml/generic_debit_request__a47021.xml[]
----
[NOTE]
====
The payment method can be any payment method that provides the redirect feature.
====

[#GeneralPlatformFeatures_RedirectURL_Request]
==== Determined in Request

In this request the redirect URL overwrites the redirect configuration
in the MAID.

.General Request Sample for Redirect URL

[source,xml,subs=attributes+]
----
include::samples/xml/generic_debit_request__6100a3.xml[]
----
[NOTE]
====
The payment method can be any payment method that provides the redirect feature.
====

[#GeneralPlatformFeatures_InstrumentCountryBounceback]
=== Instrument Country Bounceback

*Since 2015 the new VAT rules raised by the EU are applicable for
companies established in a EU member state and supply
telecommunications, broadcasting and electronic services in the
e-commerce business. The company must charge the VAT of the EU country
the end consumer belongs to.*

The bounce back feature can be used by transmitting the a two-digit
country code via:

*``<instrument-country></instrument-country>``*

It is available for the following payment methods:

- Credit Card
- SEPA Direct Debit
- Paypal
- Sofort.
- iDEAL
- Giropay (if an IBAN is sent)
- Carrier Billing

//-

The feature was implemented to support digital merchants to handle the
new VAT rules raised by the EU in a more efficient way.

It can be enabled if a merchant intends to catch this information in the
XML response.

[#GeneralPlatformFeatures_MerchantAccountResolving]
=== Merchant Account Resolving

_Merchant Account Resolving_ allows the merchant to create a transaction
without a specific Merchant Account ID (MAID) present in time of
transaction request. Instead of the MAID, a Super Merchant ID and a
Resolver Category Code is sent in the request and a _specific MAID_ used
for payment is automatically calculated by the Payment Processor Engine
during payment processing. The calculation is based on
<<GeneralPlatformFeatures_ResolvingRules, resolving rules>>.
Resolving rules define the logic for choosing the _specific MAID_.

If the merchant wants to use the Resolver feature he must get in contact
with the Merchant Support. The Merchant Support will do all the
necessary customizing.

[#GeneralPlatformFeatures_ResolvingRules]
==== Resolving Rules

Resolving rules define the logic for the resolver engine. Based on these
rules a _final MAID_ is selected and used for the payment process. The
rules are logic expressions and several rules with a different priority
can be defined. The first rule that matches the conditions is
automatically processed and appropriate MAID is used. Other rules with
lower priority are ignored. These rules are configured by our Merchant
Support team based on the Merchant's specific requirements.

[#GeneralPlatformFeatures_ResolverCategoryCode]
==== Resolver Category Code

_Resolver Category Code_ is a field that defines groups of several
resolving rules. This allows the merchant to define more sets of
resolving rules and lets him decide which will be used for resolving in
time of payment request. Merchant Support provides the value to merchant
when sets of rules are configured.

[#GeneralPlatformFeatures_ResolvingPaymentMethods]
==== Supported Payment Methods

_Merchant Account Resolving_ is available for _Credit Card_ and all
other alternative payment methods.

[#GeneralPlatformFeatures_ResolvingSpecified]
==== Specifying Resolvers

Resolving rules for Credit Cards can be based on:

- BIN routing for 3D Secure handling (Non-3D / 3D Merchant Account ID)
- BIN routing for different fraud rule handling
- BIN routing for different acquirer handling
- Routing based on Credit Card brand
- Routing based on Amount
- Routing based on custom parameters

//-

[#GeneralPlatformFeatures_ResolvingSuperMerchant]
==== Super Merchant

Super Merchant or Super Merchant ID is basically a group of several
MAIDs. When the merchant does not send a MAID specifically in the
request, Resolver needs to know a set of several MAIDs to choose from.
Basically it's like an Account ID superior to several MAIDs. the
Merchant Support configures Super Merchant and its inherent MAIDs.

NOTE: The payment *response* (structured payment by seamless or message POST
to merchant's page) *contains* resolved merchant and *signature computed
with secret key of resolved merchant*.

[#GeneralPlatformFeatures_Transactions]
=== Transactions

[#GeneralPlatformFeatures_ReferencingTransaction]
==== Referencing a Transaction

With the _{payment-gateway}_ a payment process can reference two
subsequent transactions.

This reference can be accomplished in two different ways:
- For alternative payment methods (such as _PayPal_ and _SEPA_) and
_credit card_ the merchant can reference transactions via the
transaction ID.
- For _credit card_ payments the merchant can also
 <<CreditCard_PaymentFeatures_Tokenization, use a token>>.

//-

[#GeneralPlatformFeatures_ReferencingTransaction_byID]
===== Referencing by Transaction ID

Referencing by transaction ID uses the field <``parent-transaction-id``>.

In that case the <``transaction-id``> of the preceding transaction will be
referenced as the <``parent-transaction-id``> of the follow up transaction.

Be aware that the ``parent-transaction-id`` is also referred to as
``reference-transaction-id``.

The following example for PayPal shows the use of
<``parent-transaction-id``>:

[%autowidth]
|===
|Transaction No. |Transaction Type |<transaction-id> |<parent-transaction-id>

|#1 |authorization |1234567 |empty
|#2 |capture-authorization |8901235 |1234567
|etc |void-authorization |6789012 |8901235
|===

[#GeneralPlatformFeatures_Transactions_Recurring]
==== Recurring Transaction

A recurring transaction is a repetitive set of transactions. In general
the recurrence occurs on a regular basis (e.g. paying annual fees for an
insurance). A <<GeneralPlatformFeatures_ReferencingTransaction, reference to such a transaction>>
always means that the subsequent transaction has
a functional dependency on the preceding transaction.

This could be, for example, a repeating transaction in a standard
transaction workflow which occurs on a regular schedule.

To submit a recurring transaction, the merchant must submit a request
with a specific transaction type. It depends on the payment method,
which transaction types apply. Currently the _{payment-gateway}_
supports recurring transactions with the payment methods <<CreditCard, Credit Card>>,
<<API_PaymentMethods_PayPal, PayPal>>, and <<SEPA>>.
If the merchant wants to use recurring transactions the request must
provide the corresponding PERIODIC TYPE and a SEQUENCE TYPE.

[#GeneralPlatformFeatures_Transactions_Recurring_Periodic]
===== The Periodic Type

The *PERIODIC TYPE* element is chosen specifically by the merchant and
depends on the merchant's business model. One of the following two
periodic types must be chosen:

- *_installment_:* one in a set that completes a financial transaction
and
- *_recurring_*: one in a set that occurs repeatedly, such as a
subscription.

//-

Both transactions will be processed the same way.

[#GeneralPlatformFeatures_Transactions_Recurring_Sequence]
===== The Sequence Type

Additionally, the sub-element *SEQUENCE TYPE* with one of the following
sequences must be submitted:

- _*first*_: The first transaction in a series of recurring transactions
- _*recurring*_: A transaction that is part of a series of recurring
transactions.
- _*final*_: The final transaction in a series of recurring
transactions. A payment with this sequence type completes a chain of
recurring payments.

//-

[#GeneralPlatformFeatures_Transactions_Recurring_Restrictions]
===== Restrictions

To ensure proper processing, please take into consideration the
following restrictions:

- _Recurring_ and _final_ transactions are required to be matched to
the _first_ transaction.
- A request with sequence type _first_ may only contain a
parent-transaction ID referring to another transaction which has been
submitted without a periodic type.
- A _recurring_ or _final_ transaction may only be referenced to a
parent _first_ if it is on status SUCCESS.
- Where a _first_ transaction has been voided, a
subsequent _recurring_ or _final_ transaction will not be accepted.
- After a transaction with sequence type _final_ has been submitted, it
is not possible to submit another _recurring_ or _final_ transaction for
this series.
- Only one periodic type may be used for the complete series of
recurring payments. This means that the periodic type in a subsequent
transaction must match the periodic type sent in the _first_ request.

[#GeneralPlatformFeatures_RetrieveTransaction]
==== Retrieve a Transaction

The _{payment-gateway}_ allows the merchant to submit payment
transactions, as well as search for payments and merchant data. 

In the standard process, the merchant is informed via <<GeneralPlatformFeatures_IPN, IPN>>
about the status of a submitted transaction. _Retrieve Transaction_ is
an option for the merchant to find out the status of a transaction, if,
for some reason, the IPN has not been received. Lacking an IPN can
happen due to the fact that the transaction has not reached its final
status or additional information from providers are not present at the
point of time the _Retrieve_ query was sent. So in case the notification
was sent the status is final.

There are <<GeneralPlatformFeatures_IPN_Delay, several reasons>>
why _Retrieve Transaction_ shall not be launched immediately
after submitting a transaction and still waiting for the IPN.

[#GeneralPlatformFeatures_RetrieveTransaction_Formats]
===== Formats and Methods

[cols="h,"]
|===
|Request Formats | XML, NVP (credit card only)
|Response Formats | XML, HTML, JSON
|Request Methods | GET
|===

[#GeneralPlatformFeatures_RetrieveTransaction_TransactionID]
===== Retrieve Transaction by Transaction-ID

Retrieving a transaction using a _Transaction-ID_ returns a single
transaction belonging to a merchant account. The _Transaction-ID_
attribute must match the value that was included in the transaction
response sent by Wirecard. An error occurs if the _Transaction-ID_ is
not available (request must be submitted later again) or the requested
user is not authorized to see the content. The desired content type can
be set through the _Accept_-header or by specifying an extension.

The <<GeneralPlatformFeatures_IPN, Notification file (IPN)>> the merchant gets (based on configuration), is the standard
process to gather information about a submitted transaction. The reason
for this is that it could happen that the transaction has not reached
final status or additional information from providers are not present at
the point of time the _Retrieve_ query was sent. So in case the
notification was sent the status is final.

[#GeneralPlatformFeatures_RetrieveTransaction_TransactionID_Endpoint]
====== Endpoint

[cols="h,"]
|===
|URL

|``\https://{test-instance-hostname}/engine/rest/merchants/{merchant-account-id}/payments/{transaction-id}``
|===

[#GeneralPlatformFeatures_RetrieveTransaction_TransactionID_Fields]
====== Fields

Mandatory (M) or optional (O).

[%autowidth]
|===
|Field |Cardinality |Datatype |Size

|merchant-account-id |M |Alphanumeric |36
|transaction-id |M |Alphanumeric |36
|===

[#GeneralPlatformFeatures_RetrieveTransaction_TransactionID_SampleURL]
====== Sample URL to a Merchant's Endpoint

``\https://{test-instance-hostname}/engine/rest/merchants/ba261be8-af94-11df-ab7800163e5eafd7/payments/048b27e0-9c31-4cab-9eab-3b72b1b4d498``

[#GeneralPlatformFeatures_RetrieveTransaction_TransactionID_Response]
====== Response when retrieving a transaction

The response corresponds to the transaction type of the transaction
being retrieved. For example, the transaction type = 'purchase' and the
transaction type = 'tokenize' have different responses when the
transaction is being created and that same response will occur for this
retrieval. See the sample responses as described for each transaction
type.

[#GeneralPlatformFeatures_RetrieveTransaction_RequestID]
===== Retrieve Transaction by Request-ID

Retrieving a transaction using a Request-ID returns a single transaction
belonging to a Merchant Account. The request-id attribute must match a
request-id that was submitted during the creation of a transaction. An
error is returned if the request-id is not available or the user is not
authorized to see the content. The desired content type can be set
through the "Accept"-header with value "*application/xml*" or by
specifying an extension.

[#GeneralPlatformFeatures_RetrieveTransaction_RequestID_Endpoint]
====== Endpoint

[cols="h,"]
|===
|URL
|``\https://{test-instance-hostname}/engine/rest/merchants/\{merchant-account-id}/payments/search?payment.request-id=\{request-id}``
|===

[#GeneralPlatformFeatures_RetrieveTransaction_RequestID_Fields]
====== Fields

Mandatory (M) or optional (O).

[%autowidth]
|===
|Field |Cardinality |Datatype |Size

|merchant-account-id |M |Alphanumeric |36
|request-id |M |Alphanumeric |150
|===

[#GeneralPlatformFeatures_RetrieveTransaction_RequestID_Sample]
====== Sample URL to a Merchant's Endpoint

``\https://{test-instance-hostname}/engine/rest/merchants/ba261be8-af94-11df-ab78-00163e5eafd7/payments/search?payment.request-id=048b27e0-9c31-4cab-9eab-3b72b1b4d498``

[#GeneralPlatformFeatures_RetrieveTransaction_RequestID_Response]
====== Response when retrieving a transaction

The behavior of a response is the same no matter whether you receive it
for a transaction by _Request-ID_ or Transaction-ID.

The details are described in section
<<GeneralPlatformFeatures_RetrieveTransaction_TransactionID, Retrieve Transaction by Transaction-ID>>.

[#GeneralPlatformFeatures_RetrieveTransaction_RequestIDCategory]
===== Retrieve Transaction by Request-ID and Category

Retrieving a transaction using a Request-ID and Category returns a
single transaction belonging to a Super Merchant Account with resolving
category. The request-id attribute must match a request-id that was
submitted during the creation of a transaction with Super Merchant. An
error is returned if the request-id is not available or the user is not
authorized to see the content. The desired content type can be set
through the "Accept"-header with value "*application/xml*" or by
specifying an extension.

[#GeneralPlatformFeatures_RetrieveTransaction_RequestIDCategory_Endpoint]
====== Endpoint

[cols="h,"]
|===
|URL
|``\https://{test-instance-hostname}/engine/rest/resolver-category/{category-id}/payments/?request_id={request-id}``
|===

[#GeneralPlatformFeatures_RetrieveTransaction_RequestIDCategory_Fields]
====== Fields

Mandatory (M) or optional (O).

[%autowidth]
|===
|Field |Cardinality |Datatype |Size

|``request-id`` |M |Alphanumeric |150
|``resolver-category`` |M |Alphanumeric |32
|===

[#GeneralPlatformFeatures_RetrieveTransaction_RequestIDCategory_SampleURL]
====== Sample URL to a Merchant's Endpoint

``\https://{test-instance-hostname}/engine/rest/resolver-category/CATEGORY_X/payments/?request_id=c1052ad7-1372-4755-b6e1-fb32e7519be1``

[#GeneralPlatformFeatures_RetrieveTransaction_RequestIDCategory_SampleResponse]
====== Sample: XML Authorization Response (Successful)


[source,xml,subs=attributes+]
----
include::samples/xml/GeneralPlatformFeaturesRetrieveTransactionRequestIDCategorySampleResponse_GeneralRequestSampleForRedirect_URL.xml[]
----

[#GeneralPlatformFeatures_Transactions_Storing]
==== Storing Additional Data

In addition to processing transactions, _{payment-gateway}_ also
permits the storage and later retrieval of additional information.

The use of  the header "custom-field" permits the client application to
store key-value pairs with each transaction.


In the following example, the client application has stored a _purchase order_,
_invoice_, _crm-id_, _customer-tier_ and _promotional-code_.

This information is also echoed back in any response querying the status
of a transaction.  It is also possible to see this information in the
reporting system.

[source,xml,subs=attributes+]
----
include::samples/xml/GeneralPlatformFeaturesTransactionsStoring.xml[]
----

[#GeneralPlatformFeatures_Transactions_View]
==== View Transactions in Browser

You can check your transactions in the browser. All you need is the
following URL:

``\https://\{hostname}/engine/rest/merchants/\{merchant-account-id}/payments/search?payment.request-id=\{request-id}``

Enter this URL in your browser and replace the following variables:

- {hostname}:
* if test environment: \http://{test-instance-hostname}
* if production environment: \http://{instance-hostname}
- {merchant-account-id}: Use the appropriate Test Merchant Account ID
- {request-id}: Use the appropriate Request ID

//-

When you login with the username and password of the test account, you
can see the result of the transaction in your browser.

[#GeneralPlatformFeatures_Transactions_TransactionTypes]
==== Transaction Types


[#GeneralPlatformFeatures_Transactions_CheckSignatureAuthorization]
===== _check-signature/authorization_

_check-signature_ and its related transaction types are transaction
types that are dependent on the payment method not of elementary need for
processing via _{payment-gateway}_. Some payment methods just
provide the possibility to verify if this payment method is allowed to
process by this consumer account or to verify if the account data are
valid. In _{enterprise-portal-abbr}_ both Transaction Types are visible.   

[NOTE]
====
.Example
For <<Sofort>> the transaction type _check-signature_ can be submitted to validate the
digital signature.
====

[#GeneralPlatformFeatures_Transactions_GetUrlPendingDebitCredit]
===== _get-url/pending-debit/pending-credit_

_get-url_ and its related transaction types are transaction types that
depend on the payment method of elementary need for processing via
_{payment-gateway}_. Because of that for some payment methods
they are additionally created automatically even they were not sent via
the integration option. In _{enterprise-portal-abbr}_ these Transaction Types are visible.

[NOTE]
====
.Example
For <<SEPADirectDebit, SEPA Direct Debit>> the transaction type _pending-credit_ is created in
addtion to the _credit_ that was submitted to visualize the process
steps.

- submitted _credit_ => visible in _{enterprise-portal-abbr}_ _pending-credit_ and _credit_
- submitted _debit_ => visible in _{enterprise-portal-abbr}_ _pending-debit_ and _debit_
====


[#GeneralPlatformFeatures_Transactions_AutoSale]
===== _auto-sale_

_auto-sale_ is a pseudo transaction type, which has been created for the
purpose of offering merchants and easier way to integrate the standard
and most widely used "SALE" transactions. _auto-sale_ does not exist as
an individual transaction type. It is only a place-holder which is used
by the _{payment-gateway}_ to decide which transaction type
should be used for a specific transaction. When using _auto-sale_,
the merchant is not required to send a specific transaction-type for
each credit card or alternative payment method request.

[#GeneralPlatformFeatures_Transactions_AutoSale_BasicConfiguration]
====== Basic Configuration

A merchant is automatically configured to use the default settings for
_auto-sale_.

The _{payment-gateway}_ has already configured a default
transaction type for _auto-sale_ per payment method. The default values
are:

- For credit card, _auto-sale_ corresponds to  _purchase._
- For all other alternative payment methods, _auto-sale_ corresponds to
_debit._

//-

If a merchant sends in a transaction with transaction type _auto-sale_,
these default values will be used.

The transaction type stored in the database for a transaction request
will not be stored as _auto-sale_, meaning the response to a payment
request will include the actual transaction type and not _auto-sale_. It
will be stored with the transaction type configured behind _auto-sale_.
For example, a credit card transaction will be stored with transaction
type _purchase_.

[#GeneralPlatformFeatures_Transactions_AutoSale_ExtendedConfiguration]
====== Extended Configuration

A merchant may override these default transaction types by configuring
their own default transaction types. Each payment method may be
configured individually for _auto-sale_.

This is configured in the merchant account setup. For example, a
merchant may specify that for credit card, _auto-sale_ shall correspond
to _authorization_. This will override the automatically set
correspondence of _auto-sale_ to _purchase_.

Please contact Merchant Support to setup an extended configuration.

[#GeneralPlatformFeatures_Transactions_AutoSale_Currency]
====== Currency Configuration

In addition to transaction type, _auto-sale_ may also be configured for
a specific currency. The merchant is able to have multi default
transaction types depending on the currency.

.Example

``Merchant-id-1``, ``Creditcard``, ``EUR``, ``authorization``;
``Merchant-id-1``, ``Creditcard``, ``CZK``, ``purchase``;
``Merchant-id-1``, ``Creditcard``, ``GBP``, ``authorization-only``;


[#GeneralPlatformFeatures_ServerAvailability]
=== Server Availability

When you want to find out, whether the _{payment-gateway-abbr}_ servers are available, you
can use a link to the _{payment-gateway-abbr}_ status page:

https://{instance-hostname}/engine/status/

The status page shows the general status of the _{payment-gateway-abbr}_.

It also shows the online status of database and tokenization server.

For reference you can also see the current server time.

Please use a slash "/" after "status", otherwise this page will ask for
credentials.

Please be aware that each server request means data traffic. Use this
request carefully. Use it only, if you encounter server connection
problems.

[#GeneralPlatformFeatures_IPP]
=== Installment Payment Plan (IPP)

**I**nstallment **P**ayment **P**lan is a feature that allows the consumer to pay in equal installments. +
Depending on the total order amount, you can offer various payment plans to the consumer. These IPPs differ in tenure and installment payment framework (e.g. interest rate). +
 +
Set up a contract with your issuing bank to agree on the IPP parameters. The issuing bank then provides Wirecard with these IPP parameters.

////
- **tenure:** duration of installment payment in months. Depends on financial institutions
and ranges from 3 months to 24 months.
- **program:** installment payment framework, e.g.
** minimum amount for installment payments: Only payments with a total amount
higher than this value qualify for installment payment.
** payment delay: The start date of installment payment can be postponed.
** interest rate
////

//-

NOTE: If your merchant account has not yet been set up for IPP, <<ContactUs, contact merchant support>>.

.IPP Characteristics
- *Fixed*: Installments are of equal amount.
- *On-us:* Issuing bank and acquiring bank are the same.
- *Issuer-based:* Post-clearing, you receive the full amount from the acquiring bank. The consumer pays their issuing bank (same entity as acquiring bank since *on-us*) in installments.
- *Domestic payments only:* The instrument country, i.e. the country where the
consumer's card was issued, must match the merchant country.
- *Domestic currency only:* The consumer can only pay in the local currency of the merchant country.
- *Credit card:* This feature is available for credit card payments only. +
_Supported card brands:_
+
* Mastercard
* Visa
//-

[#GeneralPlatformFeatures_IPP_CountriesCurrencies]
[discrete]
==== Countries and Currencies

[#GeneralPlatformFeatures_IPP_Scenarios_Fields]
[%autowidth]
[cols="h,"]
|===
|Countries
|HK, ID, MY, PH, SG, TH, TW

|Currencies
|HKD, IDR, MYR, PHP, SGD, THB, TWD
|===


[#GeneralPlatformFeatures_IPP_TransactionTypes]
[discrete]
==== Transaction Types
**I**nstallment **P**ayment **P**lan works with transaction type _purchase_.

////
[#GeneralPlatformFeatures_IPP_Setup]
==== Setting up IPP
[discrete]
[#GeneralPlatformFeatures_IPP_Setup_Prerequisites]
===== Prerequisites
Merchant and issuing bank have to contractually agree upon basic IPP
parameters:

- **tenure:** duration of installment payment. Depends on financial institutions
and ranges from 3 months to 24 months.
- **program:** installment payment framework, e.g.
** minimum amount for installment payments: Only payments with a total amount
higher than this value qualify for installment payment.
** payment delay: The start date of installment payment can be postponed.
** interest rate
** BIN range: valid **B**ank **I**dentification **N**umbers. Lists all
issuing banks that qualify for installment payment.

//-

The issuer provides Wirecard with these IPP parameters.

[discrete]
[#GeneralPlatformFeatures_IPP_Setup_MerchantSetup]
===== Merchant Setup
Merchant setup basically follows the standard setup process. +
You need a **unique MAID** for IPP. +
Two additional features must be activated on the merchant account configuration:

- **installment plan:** Activate ``installment_plan_enabled``.
- **on-us card routing:** Activate ``onus_enabled``.

<<ContactUs, Merchant Support>> assists you in setting up your account properly.

NOTE: The basic IPP parameters must be setup as defined in
<<GeneralPlatformFeatures_IPP_Setup,Prerequisites>>.
////

////
[#GeneralPlatformFeatures_IPP_Scenarios]
==== IPP Scenarios
There are two different IPP scenarios:

1. Consumer has only one credit card.
2. Consumer has several credit cards to select from.

//-
////

[#GeneralPlatformFeatures_IPP_Workflow]
[discrete]
//===== 1. Consumer has only one credit card
==== Workflow
. The consumer checks out products in the merchant's shop.
. The merchant's shop displays the payment form, where the consumer enters their credit card data (PAN).
. WPG checks the card's IPP eligibility by validating the card number against the BIN ranges activated at the issuing bank.
The BIN range is part of the contract between merchant and issuing bank. It lists all  **B**ank **I**dentification **N**umbers (the first 6 digits of credit card number) that qualify for installment payment.
//+
//The BIN range lists all **B**ank **I**dentification **N**umbers that qualify for installment payment.
+
WPG also checks if the transaction and the transaction currency are domestic.

* Validation fail: The consumer is redirected to the regular (credit card) payment form.
* Validation OK: The consumer can select either regular payment or payment in installments.
. The consumer selects "Payment in Installments".
. The merchant sends an <<GeneralPlatformFeatures_IPP_InstallmentCalculator, Installment Calculator>> request to WPG.
. WPG forwards the request to the issuing bank.
. The issuing bank generates a list of all available IPPs and sends it to the merchant.
. The merchant's shop displays the available installment plans to the consumer (on the checkout page).
. The consumer selects an installment plan and submits the payment. The selected program/tenure is sent with the _purchase_ request to WPG.
*Mandatory IPP fields* in this _purchase_ request are <<GeneralPlatformFeatures_IPP_Fields, __tenure__>> and <<GeneralPlatformFeatures_IPP_Fields, __program-id__>>.
. WPG forwards the request to the issuing bank.
. The issuing bank processes the request and sends the response to WPG.
. WPG forwards the response to the merchant.
. The merchant informs the consumer about the transaction outcome.
. The issuing bank pays the total order amount to the merchant.
. The consumer pays the issuing bank (same
  entity as acquiring bank since *on-us*) in installments.

[#GeneralPlatformFeatures_IPP_Fields]
[discrete]
==== Fields
A _purchase_ request with IPP requires two additional **mandatory** fields that identify the installment plan selected by the consumer:

[%autowidth]

|===
|Field |Data Type |Size |Description

m|tenure
|Integer
|10
|Installment tenure. Number of months the consumer has to pay in installments. +
Enter the respective value from the field ``months`` provided in the Installment Calculator response.

m|program-id
|Alphanumeric
|36
|This ID uniquely identifies the corresponding installment payment plan framework. +
Enter the respective value from the field ``program-id`` provided in the Installment Calculator response.

|===

Two additional fields are sent in the response to this request:

[%autowidth]
|===
|Field |Data Type |Description

m|monthly-pay
|Decimal
|Amount that the consumer pays to the issuing bank per month.

m|interest-rate
|Decimal
|Interest rate of the selected IPP.

|===

////
[#GeneralPlatformFeatures_IPP_Scenario2]
[discrete]
===== 2. Consumer has multiple credit cards

.Workflow
1. Consumer checks out products in merchant's shop.
2. Merchant forwards payment request to WPG. This request must include the MAID.
3. WPG sends all IPPs that are available for this MAID to the merchant. +
// These IPPs match the IPP criteria such as minimum amount eligible for installment or country and currency of order.
4. Merchant displays these IPPs to consumer.
5. Consumer selects from the list of available banks and list of available programs.
6. Merchant displays payment form, where consumer is to enter card data (PAN).
7. WPG checks card's IPP eligibility by validating the card number against the
<<GeneralPlatformFeatures_IPP_Setup, BIN ranges>> activated at the issuing bank.
WPG also checks if the transaction is domestic.
** Validation fail: Consumer is redirected to the regular (credit card) payment form.
** Validation OK: Consumer can select either regular payment or payment in
installments.
8. If consumer selects "Payment on Installments", merchant
sends an <<GeneralPlatformFeatures_IPP_InstallmentCalculator, Installment Calculator>> request to WPG. This request
contains the order amount and the ISO locale code (including country and
  language).
9. WPG forwards the request to the issuing bank.
10. The issuing bank generates a list of all available IPPs and sends it
to the merchant.
11. Merchant shows the available installment plans to the consumer
(on the checkout page).
12. Consumer selects the appropriate installment plan. By submitting,
   the selected programure is sent with the __purchase__ request to WPG. The mandatory <<GeneralPlatformFeatures_IPP_Scenarios_Fields, fields for the __purchase__ request>> are the same as for scenario 1.
////

[#GeneralPlatformFeatures_IPP_InstallmentCalculator]
==== Installment Calculator
The Installment Calculator retrieves the available installment plans defined in the contract between the merchant and the issuing bank.

////
* **Input:** purchase amount and currency +
* **Output:** available IPPs with tenure and interest rate

//-

[#GeneralPlatformFeatures_IPP_InstallmentCalculator_Workflow]
[discrete]
===== Installment Calculator Workflow
1. Merchant sends the Installment Calculator request to WPG. This request
contains the order amount and the ISO locale code (including country and
  language).
2. WPG forwards the request to the issuing bank.
3. The issuing bank generates a list of all available IPPs and sends it
to the merchant.
////

.Endpoints
[cols="1h,3"]
|===
|Test URL       |``\https://{test-instance-hostname}/engine/rest/utils/installmentcalculator``
|Production URL |``\https://api.wirecard.com/engine/rest/utils/installmentcalculator``
|===

.Test Credentials
[cols="1h,3"]
|===
|Merchant Account ID |6dcd81a6-88d0-42ef-a37e-a8cc0b6ab122
|Username            |45892-IPPS
|Password            |5D348E1jE246-g
|===

.Communication Formats
[cols="1h,3"]
|===
| Format   | XML
| Methods  | POST
|===

[#GeneralPlatformFeatures_IPP_InstallmentCalculator_Fields]
.Request Fields
[#GeneralPlatformFeatures_IPP_InstallmentCalculator_Fields_MO1]
M=**M**andatory, O=**O**ptional
[%autowidth]
[cols="m,,,,"]
|===
|Field |<<GeneralPlatformFeatures_IPP_InstallmentCalculator_Fields_MO1, *M/O*>> |Data Type |Size |Description

|merchant-account-id
|M
|Alphanumeric
|36
|Unique identifier of merchant account.

|payment-method
|M
|Enumeration
|15
|Set to ``creditcard``.

//|amount
//|M
//|Numeric
//|18,3
//|Total order amount. +
//The number of decimal places depends on the currency.

//|amount@currency
//|M
//|Alphanumeric
//|3
//|Order currency. Must match currency of merchant country.

|account-number
|M
|Token
|36
|Consumer's credit card number (primary account number).

//|locale
//|M
//|Alphanumeric
//|5
//|Locale code containing country and language code. +
//E.g. en_SG for English language in Singapore. +
//The language defines the localized labels of the result fields.
|===

.Response Fields
[#GeneralPlatformFeatures_IPP_InstallmentCalculator_Fields_MO2]
M=**M**andatory, O=**O**ptional
[%autowidth]
[cols="m,,,,"]
|===
|Field |<<GeneralPlatformFeatures_IPP_InstallmentCalculator_Fields_MO2, *M/O*>> |Data Type |Size |Description

|merchant-account-id
|M
|Alphanumeric
|36
|Unique identifier of merchant account.

|payment-method
|M
|Enumeration
|15
|Always ``creditcard``.

//|amount
//|M
//|Numeric
//|18,3
//|Total order amount. +
//The number of decimal places depends on the currency.

//|amount@currency
//|M
//|Alphanumeric
//|3
//|The currency in which the order was placed.

//|locale
//|M
//|Alphanumeric
//|5
//|Locale code containing country and language code. +
//E.g. en_SG for English language in Singapore. +
//The language defines the localized labels of the result fields.

|state
|M
|Enumeration
|
|The state of the response: ``success``, ``failed``.

|statuses
|M
|Complex
|
|List of response statuses.

|statuses.status
|M
|Complex
|
|Response status.

|statuses.status@code
|M
|Alphanumeric
|12
|The status code of the response. Click
<<StatusCodes, Status Codes and Transaction Status>> for a complete list
of all status codes.

|statuses.status@description
|M
|Alphanumeric
|256
|The description to the response status code.

|statuses.status@severity
|M
|Enumeration
|
|Possible values: ``warning``, ``error`` or ``information``.

|installments
|M
|Complex
|
|Contains all available IPPs.

|installments.installment
|M
|Complex
|
|Each installment complex contains information on a specific IPP framework.

|installments.installment. +
program-id
|M
|Alphanumeric
|36
|This ID uniquely identifies the corresponding IPP framework. +
 Insert this value as ``program-id`` of a subsequent purchase request.

|installments.installment. +
program-name
|O
|Alphanumeric
|
|Label of this specific IPP framework as displayed to the consumer. +
This is just a suggestion and may be replaced by any text you find more conclusive for your consumer.

|installments.installment. +
details
|M
|Complex
|
|Breakdown of information on the
corresponding IPP.

//|installment-calculator-response.installments.installment.details. +
//tenures
//|M
//|Alphanumeric
//|
//|Lists all available tenures.

|installments.installment. +
details.months
|M
|Alphanumeric
|10
|Number of installments (months) to pay for this IPP. +
 Insert this value as ``tenure`` of a subsequent purchase request.
|===

[discrete]
[#GeneralPlatformFeatures_IPP_InstallmentCalculator_Samples]
==== Samples

.Installment Calculator Sample Request
[source,xml,subs=attributes+]
----
include::samples/xml/GeneralPlatformFeatures_IPP_InstallmentCalculatorSamples_InstallmentCalculatorSampleRequest.xml[]
----


.Installment Calculator Sample Response
[source,xml,subs=attributes+]
----
include::samples/xml/GeneralPlatformFeatures_IPP_InstallmentCalculatorSamples_InstallmentCalculatorSampleResponse.xml[]
----

//-
