
[#AppendixF]
=== F: 3D Secure General Process Workflow

image::images/16-05-appendix-f/3Dsecureprocessnew.png[3D Secure Workflow, align="center"]

[#AppendixF_3DS2FF]
==== 3D Secure 2.1 Frictionless Flow (Issuer supports version 2)

image::images/16-05-appendix-f/3DSfrictionless.svg[3D Secure 2 Frictionless Workflow, align="center"]

*1.* *Check-enrollment*: This first step initiates the payment session and checks if the consumer’s card is enrolled in the 3D Secure 2 program. +
*1.1* Consumer (cardholder) checkout on your payment page. +
*1.2* Initiate the payment session with {payment-gateway} using the *check-enrollment* transaction type. Provide additional fields for 3D Secure 2 transactions. 3D Secure 2 fields can be found in the <<CreditCard_3DS2_Fields, 3D Secure 2 field table>> and are included in the <<Appendix_Xml, REST API payment XSD>>. +
*1.3* {payment-gateway} checks the 3D Secure version supported by the issuer with the 3D Secure server. +
*1.4* {payment-gateway} returns the *check-enrollment* response. It includes the *PAReq*, the ACS URL, and the 3D Secure version. +

*2.* _Redirect the consumer to the ACS URL_ +
*2.1* Send an HTTPS POST request including the ACS URL, the *<PAReq>*, the *<TermUrl>* and *<MD>*. +
*2.2* The ACS URL points to the public endpoint of the {payment-provider-name} 3D Secure Router which decodes the *<PAReq>*. +
*2.3* The {payment-provider-name} 3D Secure Router returns an HTML with the scheme logo and a "processing" screen which is displayed in the consumer's browser. +
*2.4* The {payment-provider-name} 3D Secure Router redirects the consumer to the 3DSMethodURL for device fingerprinting. +
*2.5* The Issuer ACS gathers the information and redirects the 3D Secure method completion information to the 
{payment-provider-name} 3D Secure Router URL. +
*2.6* The {payment-provider-name} 3D Secure Router initiates authentication with the issuer's ACS via the scheme directory server. +
*2.7* After successful authentication, {payment-provider-name} 3D Secure Router posts the SSL-encrypted and digitally signed *PARes* (Payment Authentication response) to the *TermURL* via the consumer’s browser. +

*3.* *Check-payer-response* (optional) and *PARes* verification: Use this request to receive, analyze and store authentication values on your side or use your connection to the {payment-gateway} for the “MPI Only” option.  The *check-payer-response* provides the authentication values needed later for completion of the payment transaction. It is executed _after_ you receive the *check-enrollment* response and the *PARes*. +
*3.1* Send a POST request with transaction type *check-payer-response* to {payment-gateway}. Provide the ``parent-transaction-id`` using the ``transaction-id`` from the *check-enrollment* response, and the *PARes*. +
*3.2* {payment-gateway} decodes the *PARes*, checks the signature and retrieves the final authentication values.
*3.3* {payment-gateway} returns the final authentication values in the response of the *check-payer-response* transaction. These include the ``dsTransId``, ``CAAV/AVV``, ``ECI``, and ``authenticationStatus``. +


*4.* Complete the payment transaction.





image::images/16-05-appendix-f/3DSchallenge.svg[3D Secure 2 Challenge Workflow, align="center"]

image::images/16-05-appendix-f/3DSfallback.svg[3D Secure 2 Fallback Workflow, align="center"]
