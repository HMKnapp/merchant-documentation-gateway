[#API_MasterPass]
=== MasterPass

[#API_MasterPass_Introduction]
==== Introduction
[.clearfix]
--
[.right]
image::images/11-14-masterpass/masterpass_logo.png[Masterpass Logo, width=200]

_MasterPass_ is a digital wallet for faster, safer shopping, allowing
consumers to make purchases without entering shipping and credit card
information on the merchant's website, as _MasterPass_ stores the credit
card and shipping details on behalf of the consumer. The consumer
selects _MasterPass_ as the payment method, and is redirected to
_MasterPass_ to select the credit card and shipping (optional)
information.
--

_MasterPass_ supports 2 modes of requests:

- *_MasterPass_ Standard Checkout* allows the merchant to redirect the
consumer to the _MasterPass_ site to select the preferred card and
shipping details to complete the checkout.
- *_MasterPass_ Express Checkout* allows the merchant to pair (link) the
merchant account to the consumer account so that the merchant can
initiate subsequent payments to _MasterPass_ without requiring the
consumer to login to _MasterPass_. The consumer only has to login to
_MasterPass_ once and approve the pairing.

//-

The _MasterPass_ wallet can be integrated in three different ways:

[%autowidth]
|===
|Integration Option |Description

|Hosted Payment Page integration a| . The customer is redirected
to MasterPass website to login and select the preferred credit card for
payment. +
                                    . The Wirecard Payment Gateway will receive the credit card information
from _MasterPass_ and proceed with payment authorization with the
acquirer. +
                                    . The Wirecard Payment Gateway manages all interactions with
_MasterPass_.
|REST API integration for Standard Checkout |The merchant handles the
integration into _MasterPass_ based on the _MasterPass_ information provided
by the gateway.
|REST API integration for Express Checkout |The merchant handles the
integration into _MasterPass_ based on the _MasterPass_ information provided
by the gateway for both the initial and subsequent requests.
|===

[#API_MasterPass_GeneralInformation]
==== General Information

[#API_MasterPass_General_PaymentMode]
===== Payment Mode, Countries, and Currencies

This table illustrates which payment mode _MasterPass_ belongs to. It
also provides detailed information about the countries and currencies
which are relevant for _MasterPass_.

[%autowidth, cols="h,"]
|===
|Payment Mode |<<PaymentMethods_PaymentMode_Wallet, Wallet>>
|Countries |International
|Currencies |All currencies are supported.
|===

[#API_MasterPass_General_Communication]
===== Communication Formats

This table illustrates how _MasterPass_ notifications are encoded and
which formats and methods can be used for requests and responses.

[%autowidth]
|===
.2+h|Requests/Responses |Format |XML
                        |Methods |POST, GET
h|IPN Encodement      2+| Base64
|===

[#API_MasterPass_TransactionTypes]
==== Transaction Types

Every successful MasterPass payment request ends up with two distinct
transactions in the database, one for the _MasterPass_ wallet and one for
the credit card.

For <<Glossary_TransactionType, transaction type>> details which are not given
here, look at <<AppendixB, Appendix B: Transaction Types>>.

[%autowidth]
|===
|_MasterPass_ |  |_Credit Card_

|_debit_ |AND |_purchase_
|_authorization_ |AND |_authorization_
|_authorization-only_ |AND |_authorization-only_
|===

[#API_MasterPass_TestCredentials]
==== Test Credentials

[%autowidth]
|===
.2+h|URL(s) Endpoints          |Hosted Payment Page |``\https://api-test.wirecard.com/engine/hpp/``
                               |REST API |``\https://api-test.wirecard.com/engine/rest/paymentmethods/``
h|Merchant Account ID (MAID) 2+|Please contact <<ContactUs, merchant support>> for complete test credentials.
h|Username                   2+|70000-APITEST-AP
h|Password                   2+|qD2wzQ_hrc!8
h|Secret Key                 2+|87e1c187-363f-41d8-abab-7bae0fb03eca
|===

[#API_MasterPass_Workflows]
==== Workflows

[#API_MasterPass_Workflows_PaymentPage_Standard]
===== Payment Page: Standard Checkout

The Payment Page flow follows the usual Payment Page integration and
flow.

image::images/11-14-masterpass/pp_standardcheckout.png[Workflow PP Standard Checkout]

. Consumers add items to shopping basket.
. Merchants redirect consumers to _Wirecard Payment Gateway_ for
payment.
. Consumers select payment method _MasterPass_.
. _Wirecard Payment Gateway_ redirects consumers to _MasterPass_.
. Consumers enter their _MasterPass_ credentials and select preferred
card and shipping address (optional).
. _Wirecard Payment Gateway_ receives the card and shipping
address (optional) information.
. _Wirecard Payment Gateway_ processes the transaction with the
merchants' acquirer.
. _Wirecard Payment Gateway_ receives transaction status.
. _Wirecard Payment Gateway_ sends transaction status to merchants
and redirects the consumers to the merchant.
. Merchants receive the transaction's status and display the
completion of the payment process to the consumer.

//-

[#API_MasterPass_Workflows_API_Standard]
===== REST API: Standard Checkout

image::images/11-14-masterpass/api_standardcheckout.png[Workflow REST Standard Checkout]

. Consumers add items to shopping basket.
. Consumers select payment method _MasterPass_.
. Merchants initiate a _debit_ transaction.
. _Wirecard Payment Gateway_ responds with a redirect-URL to the
merchant.
. Consumers enter their _MasterPass_ credentials and select preferred
card and shipping address (optional).
. _Wirecard Payment Gateway_ receives the card and shipping
address (optional) information.
. _Wirecard Payment Gateway_ processes the transaction with the
merchants' acquirer.
. _Wirecard Payment Gateway_ receives transaction status.
. _Wirecard Payment Gateway_ sends transaction status to merchants
and redirects the consumers to the merchants.
. Merchants receive the transaction's status and display the
completion of the payment process to the consumers.

//-

[#API_MasterPass_Workflows_API_Express]
===== REST API: Express Checkout

For Express Checkout, merchants can choose to do the pairing (request
for consumer's account to be linked to merchant's account) to be handled
with or without a checkout.

[#API_MasterPass_Workflows_API_Express_Initial_PairingCheckout]

.Initial - Pairing and Checkout
image::images/11-14-masterpass/api_initial_pairingcheckout.png[Workflow REST Express Checkout - Pairing and Checkout]

. Consumers add items to shopping basket.
. Consumers select payment method _MasterPass_.
. Merchants initiate a _request-checkout_ transaction with
request-type pairing-and-checkout.
. _Wirecard Payment Gateway_ responds with a redirect-URL to the
merchants.
. Merchants initiate _MasterPass_ lightbox.
. Consumers enter their _MasterPass_ credentials and select preferred
card and shipping address (optional).
. Consumers approve pairing request
from merchants.
. _Wirecard Payment Gateway_ receives the card and shipping address
(optional) information.
. _Wirecard Payment Gateway_ returns pairing status, token and
shipping address (optional) information to merchants.
. Merchants re-calculate shipping amount (optional) and final charges
and display masked card information for consumers' confirmation.
. Merchants initiate payment request.
. _Wirecard Payment Gateway_ processes the transaction with the
merchants' acquirer.
. _Wirecard Payment Gateway_ receives transaction status.
. _Wirecard Payment Gateway_ sends transaction status to merchants.
. Merchants receive the transaction's status and display the
completion of the payment process to the consumers.

//-

[#API_MasterPass_Workflows_API_Express_Initial_Pairing]
.Initial - Pairing Only

image::images/11-14-masterpass/api_initial_pairingonly.png[Workflow REST Express Checkout - Pairing]

. Consumers add items to shopping basket.
. Consumers select payment method _MasterPass_.
. Merchants initiate a _request-checkout_ transaction with
request-type pairing.
. _Wirecard Payment Gateway_ responds with a redirect-URL to the
merchants.
. Merchants initiate _MasterPass_ lightbox.
. Consumers enter their _MasterPass_ credentials and select preferred
card and shipping address (optional).
. Consumers approve pairing request from merchants.
. _Wirecard Payment Gateway_ receives the card and shipping address
(optional) information.
. _Wirecard Payment Gateway_ returns the token and shipping address
(optional) information to merchants.
. Merchants receive the transaction status and display pairing status
to consumers.

//-

[#API_MasterPass_Workflows_API_Express_Subsequent_Express]
.Subsequent - Express Checkout

image::images/11-14-masterpass/api_subsequent_expresscheckout.png[Workflow REST Express Checkout - Express]

. Merchants initiate a _precheckout_ transaction with request-type
precheckout.
. _Wirecard Payment Gateway_ requests consumers' preferred card and
shipping address (optional) from _MasterPass_.
. _Wirecard Payment Gateway_ returns _precheckout_ information to
merchants.
. Merchants display _precheckout_ information for consumers to select
and confirm.
. Consumers select and confirm preferred card.
. Merchants submit a _request-checkout_ transaction with request-type
express-checkout.
. _Wirecard Payment Gateway_ requests for full card information
from _MasterPass_.
. _Wirecard Payment Gateway_ returns the token and shipping address
(optional) information to merchants.
. Merchants receive the transaction status.
. Merchants initiate payment request.
. _Wirecard Payment Gateway_ processes the transaction with the
merchants' acquirer.
. _Wirecard Payment Gateway_ receives transaction status.
. _Wirecard Payment Gateway_ sends transaction status to merchants.
. Merchants receive the transaction's status and display the
completion of the payment process to the consumers.

//-

The _request-checkout_ transaction with request-type express-checkout
must be initiated within 30 mins for the _precheckout_ information to be
valid.

[#API_MasterPass_Fields]
==== Fields

Fields can be mandatory (M), optional (O) or conditional (C).

[#API_MasterPass_Fields_requestcheckout]
===== _request-checkout_

The following elements are elements with differing cardinality
from the <<RestApi_Fields, REST API Fields>>.

[%autowidth]
|===
|Field |Request |Response |Notification |Data Type |Size |Description

|custom-fields/custom-field/@field-name   |M  |M  |M  |String |36 |Default as "elastic-api.merchant-origin".
|custom-fields/custom-field/@field-value  |M  |M  |M  |String |36 |The Transaction ID is
                                                                   the unique identifier for a transaction. It is generated by Wirecard.
|customer-id                              |M  |M  |M  |String |40 |Unique identifier in merchant's system that
                                                                   identifies the customer.
|payment-methods/payment-method/url       |   |M  |M  |String |   |Contains callback, acceptable_cards fields to be used to initiate _MasterPass_ Lightbox. This field
                                                                   is returned in the response for Pairing and Connect Checkout flow. Callback is
                                                                   URL-encoded and has to be URL-decoded before use.
|request-type                             |M  |M  |M  |String |   |Type of request. Supported request types include
                                                                   pairing, checkout, pairing-and-checkout, express-checkout.
|shipping/allowed-countries               |O  |O  |O  |String |   |Shipping profile created by Gateway
                                                                   specifying countries where merchant accepts shipping.
|wallet/address-id                        |O  |M  |M  |String |   |_MasterPass's_ unique ID to identify the
                                                                   customer's selected shipping information for Express Checkout flow.
|wallet/card-id                           |O  |M  |M  |String |   |_MasterPass's_ unique ID to identify the
                                                                   customer's selected card information for Express Checkout flow.
|wallet/merchant-id                       |   |M  |M  |String |   |Merchant's CheckoutId to be provided for
                                                                   Lightbox initialization.
|wallet/pair-token                        |   |M  |M  |String |   |Pairing Token to be used to initiate _MasterPass_ Lightbox.
|wallet/provider-ref                      |   |M  |M  |String |   |_MasterPass's_ precheckout Transaction-ID to identify the precheckout request.
|wallet/request-token                     |   |M  |M  |String |   |Request Token to be used to initiate _MasterPass_ Lightbox.
|===

[#API_MasterPass_Fields_precheckout]
===== _precheckout_

The following elements are elements with differing cardinality
from the <<RestApi_Fields, REST API Fields>>.

[%autowidth]
|===
|Field |Request |Response |Notification |Data Type |Size |Description

|customer-id              |M  |M  |M  |String |40 |Unique identifier in merchant's system that identifies the customer.
|transaction-id           |   |M  |M  |String |   |Current Transaction Id to be provided for the
                                                   final debit transaction.
|wallet/merchant-id       |   |M  |M  |String |   |Merchant's CheckoutId.
|wallet/provider-ref      |   |M  |M  |String |   |Current precheckout Transaction-ID to be
                                          provided for Lightbox initialization and final debit transaction.
|wallet/wallet-data       |   |M  |M  |String |   |_MasterPass's_ precheckout Data which
                                                   contains all the customer's _MasterPass_ account / address / shipping
                                                   information. This field is a Base64 encoded string of XML data. Base64
                                                   decoding is required to obtain the XML data with the necessary information.
|===



[#API_MasterPass_Fields_debit]
===== _debit_

The following elements are elements with differing cardinality
from the <<RestApi_Fields, REST API Fields>>.

[%autowidth]
|===
|Field |Request |Response |Notification |Data Type |Size |Description

|wallet/provider-ref            |C  |M  |M  |String |   |MasterPass Precheckout-ID from
                                                         wallet/provider-ref in a previous Express Checkout Transaction. Mandatory for
                                                         Express Checkout flow.
|wallet/provider-transaction-id |C  |M  |M  |String |   |MasterPass Transaction-ID from
                                                         wallet/provider-transaction-id in a previous Express Checkout Transaction.
                                                         Mandatory for Express Checkout flow.
|===

[#API_MasterPass_Samples]
==== Samples

[#API_MasterPass_Samples_Initial_PairingCheckout]
===== Initial - Pairing and Checkout

._request-checkout_ Pairing and Checkout Request (Successful)

[source,xml]
----
include::samples/xml/masterpass_request-checkout_request_success.xml[]
----

._request-checkout_ Pairing and Checkout Response (Successful)

[source,xml]
----
include::samples/xml/masterpass_request-checkout_request_success.xml[]
----

._request-checkout_ Pairing and Checkout Notification (Successful)

[source]
----
MasterPass.client.checkout({ "requestToken": "699f3012198d2dc958d688a4d21a0c909ae0698f", "callbackUrl":"https://sandbox-engine.thesolution.com/engine/notification/masterpass?payment.transaction-id=f21b063d-ac12-4580-ad7d-549a783ee5ef&payment.transaction-type=request-checkout&payment.request-type=pairing-and-checkout&payment.customer-id=unique-testid-003", "merchantCheckoutId":"a4a6w4waeskkkhudnya4w1hveovoyzec5i", "allowedCardTypes":["visa,master"], "suppressShippingAddressEnable":"true", "pairingRequestToken":"c334d6e3a4fe3e078606206b1331172d11a70b09", "requestPairing":true, "requestedDataTypes":["ADDRESS","PROFILE","CARD"], "requestExpressCheckout":true, "version":"v6" });
----

[#API_MasterPass_Samples_Initial_Pairing]
===== Initial - Pairing Only

._request-checkout_ Pairing only Request (Successful)

[source,xml]
----
include::samples/xml/masterpass_request-checkout_request_success.xml[]
----

._request-checkout_ Pairing only Response (Successful)

[source,xml]
----
include::samples/xml/masterpass_request-checkout_request_success.xml[]
----

._request-checkout_ Pairing only Notification (Successful)

[source,xml]
----
include::samples/xml/masterpass_request-checkout_request_success.xml[]
----

Initialize _MasterPass_ lightbox with the following script in the
merchant's origin_url page

.Javascript Lightbox initialization

[source,javascript]
----
MasterPass.client.connect({ "pairingRequestToken":"7575d7fecaa79454a9615b1e78e1090db8f2e38c", "callbackUrl":"https://sandbox-engine.thesolution.com/engine/notification/masterpass?payment.transaction-id=1d0ca01d-f81d-4228-a287-27f3fbd048ee&payment.transaction-type=request-checkout&payment.request-type=pairing&payment.customer-id=unique-testid-005", "merchantCheckoutId":"a4a6w4waeskkkhudnya4w1hveovoyzec5i", "requestedDataTypes":["ADDRESS","PROFILE","CARD"], "requestPairing":true, "requestExpressCheckout":true });
----

[#API_MasterPass_Samples_Subsequent_Express]
===== Subsequent - Express Checkout

._precheckout_ Express Checkout Request (Successful)

[source,xml]
----
include::samples/xml/masterpass_precheckout_request_success.xml[]
----

._precheckout_ Express Checkout Response (Successful)

[source,xml]
----
include::samples/xml/masterpass_precheckout_response_success.xml[]
----

._request-checkout_ Express Checkout Request (Successful)

[source,xml]
----
include::samples/xml/masterpass_request-checkout_request_success.xml[]
----

._request-checkout_ Express Checkout Response (Successful)

[source,xml]
----
include::samples/xml/masterpass_request-checkout_request_success.xml[]
----

[#API_MasterPass_Samples_debit]
===== _debit_

._debit_ Request (Successful)

[source,xml]
----
include::samples/xml/masterpass_debit_request_success.xml[]
----

._debit_ Response (Successful)

[source,xml]
----
include::samples/xml/masterpass_debit_response_success.xml[]
----

//-
